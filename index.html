<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SEKAR FİLO LASTİK HAK TAKİP</title>

  <script>
  (function(){
    function __pcDecodeLabel(label){
      if (!label || label.slice(0,4)!=='xn--') return label;
      var base=36,tmin=1,tmax=26,damp=700,initial_bias=72;
      function digit(cp){return cp-48<10?cp-22:cp-65<26?cp-65:cp-97<26?cp-97:base;}
      function adapt(delta,numPoints,firstTime){
        delta = firstTime ? Math.floor(delta/damp) : delta>>1;
        delta += Math.floor(delta/numPoints);
        var k=0; while (delta > (((base - tmin) * tmax) >> 1)) { delta = Math.floor(delta / (base - tmin)); k += base; }
        return k + Math.floor(((base - tmin + 1) * delta) / (delta + 38));
      }
      var n=128,i=0,bias=initial_bias; var dash=label.lastIndexOf('-'); var output=[]; var idx=4;
      if (dash>4){ for (var j=4;j<dash;j++) output.push(label.charCodeAt(j)); idx=dash+1; }
      while (idx<label.length){
        var oldi=i,w=1,k=base;
        while(true){
          if(idx>=label.length) return label;
          var d=digit(label.charCodeAt(idx++));
          i+=d*w;
          var t = k<=bias ? tmin : (k>=bias+tmax ? tmax : k-bias);
          if(d<t) break;
          w*=(base-t);
        }
        var outLen=output.length+1;
        bias=adapt(i-oldi,outLen,oldi===0);
        n+=Math.floor(i/outLen);
        i%=outLen;
        output.splice(i,0,n);
        i++;
      }
      return String.fromCharCode.apply(null, output);
    }
    window.emailNormalize = function(email){
      try{
        var s = String(email||'').trim();
        var at = s.indexOf('@'); if (at<0) return s;
        var local = s.slice(0,at);
        var domain = s.slice(at+1);
        var uni = domain.split('.').map(__pcDecodeLabel).join('.');
        try { uni = uni.toLowerCase().normalize('NFC').replace(/i\u0307/g,'i'); } catch(e){}
        return local + '@' + uni;
      }catch(e){ return String(email||'').trim(); }
    };
  })();
  </script>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="root"></div>
  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;
    const XLSX = window.XLSX;

    const TR_ILLER=["Adana","Adıyaman","Afyonkarahisar","Ağrı","Aksaray","Amasya","Ankara","Antalya","Ardahan","Artvin","Aydın","Balıkesir","Bartın","Batman","Bayburt","Bilecik","Bingöl","Bitlis","Bolu","Burdur","Bursa","Çanakkale","Çankırı","Çorum","Denizli","Diyarbakır","Düzce","Edirne","Elazığ","Erzincan","Erzurum","Eskişehir","Gaziantep","Giresun","Gümüşhane","Hakkari","Hatay","Iğdır","Isparta","İstanbul","İzmir","Kahramanmaraş","Karabük","Karaman","Kars","Kastamonu","Kayseri","Kırıkkale","Kırklareli","Kırşehir","Kilis","Kocaeli","Konya","Kütahya","Malatya","Manisa","Mardin","Mersin","Muğla","Muş","Nevşehir","Niğde","Ordu","Osmaniye","Rize","Sakarya","Samsun","Siirt","Sinop","Sivas","Şanlıurfa","Şırnak","Tekirdağ","Tokat","Trabzon","Tunceli","Uşak","Van","Yalova","Yozgat","Zonguldak"];

    const LS_KEY  = "lastik_takip_v1";
    const FMT = /^(\d{2})\.(\d{2})\.(\d{2})$/;
    const pad2 = n => String(n).padStart(2,"0");
    const fmt  = d => `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${d.getFullYear().toString().slice(-2)}`;
    const today= () => fmt(new Date());
    function toDate(s){
      const m = FMT.exec(String(s ?? "")); if(!m) return null;
      const d = new Date(`${2000+ +m[3]}-${m[2]}-${m[1]}T00:00:00`);
      if(isNaN(d)) return null;
      if(d.getDate()!=+m[1]||d.getMonth()+1!=+m[2]) return null;
      return d;
    }
    const daysInc=(a,b)=>Math.floor((b-a)/86400000)+1;
    const prorata=(yk,s,e)=>{ const ds=toDate(s), de=toDate(e); if(!ds||!de||de<ds) return 0; return yk*(daysInc(ds,de)/365); };
    function normExcelDate(v){
      if(v==null) return "";
      if(typeof v==="number" && XLSX.SSF && XLSX.SSF.parse_date_code){
        const o=XLSX.SSF.parse_date_code(v); if(o && o.y && o.m && o.d) return fmt(new Date(o.y,o.m-1,o.d));
      }
      const s=String(v).trim(); if(FMT.test(s)) return s;
      const m=/^(\d{4})-(\d{2})-(\d{2})$/.exec(s);
      if(m){ const d=new Date(`${m[1]}-${m[2]}-${m[3]}T00:00:00`); if(!isNaN(d)) return fmt(d); }
      const d=toDate(s); return d?fmt(d):s;
    }
    function download(name, text){
      const a=document.createElement("a");
      a.href=URL.createObjectURL(new Blob([text],{type:"text/plain;charset=utf-8"}));
      a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000);
    }
    function csvSafe(v){ const s = String(v ?? ''); return (/^[=+@-]/).test(s) ? "'" + s : s; }
    function normalizeTR(s){ try{ return String(s||'').toLowerCase().normalize('NFC').replace(/ş/g,'s').replace(/ı/g,'i').trim(); }catch{ return String(s||'').toLowerCase().trim(); } }

    function AracPanel({ araclar, onClose, onImportXLSX, onSil, onKaydet }){
      const pageSize = 50;
      const [q, setQ]     = useState("");
      const [page, setPage]= useState(1);
      const fileRef       = useRef(null);

      const filtered = useMemo(()=>{
        const s = q.trim().toUpperCase();
        if(!s) return araclar;
        return araclar.filter(a =>
          String(a.plaka||"").toUpperCase().includes(s) ||
          String(a.firma_id||"").toUpperCase().includes(s) ||
          String(a.arac_ebat||"").toUpperCase().includes(s) ||
          String(a.notlar||"").toUpperCase().includes(s)
        );
      },[q,araclar]);

      const pageCount = Math.max(1, Math.ceil(filtered.length / pageSize));
      useEffect(()=>{ setPage(1); }, [q, araclar]);
      const pageRows = useMemo(()=>{
        const start=(page-1)*pageSize;
        return filtered.slice(start,start+pageSize);
      },[filtered,page]);

      const [editOpen, setEditOpen] = useState(false);
      const [editRow, setEditRow]   = useState(null);
      function openEdit(row){
        setEditRow({
          ...row,
          originalPlaka: row.plaka,
          yillik_km_hakki: row.yillik_km_hakki==null ? "" : String(row.yillik_km_hakki)
        });
        setEditOpen(true);
      }
      function saveEdit(){
        if(!editRow) return;
        const ok = onKaydet(editRow.originalPlaka, editRow);
        if(ok){ setEditOpen(false); setEditRow(null); }
      }

      return (
        <div className="fixed inset-0 z-50 bg-white overflow-y-auto">
          <div className="max-w-7xl mx-auto p-4">
            <div className="flex items-center justify-between mb-3">
              <h2 className="text-xl font-semibold">Araç Bilgisi</h2>
              <div className="flex gap-2">
                <input ref={fileRef} type="file" className="hidden" accept=".xlsx,.xls" onChange={(e)=>onImportXLSX(e)} />
                <button onClick={()=>fileRef.current?.click()} className="px-3 py-1.5 rounded-lg border">Excel İçe Al</button>
                <button onClick={onClose} className="px-3 py-1.5 rounded-lg border">Kapat</button>
              </div>
            </div>

            <div className="flex items-end gap-2 mb-3">
              <div className="grow">
                <label className="block text-xs text-gray-500">Ara</label>
                <input value={q} onChange={e=>setQ(e.target.value)} placeholder="Plaka, firma_id, ebat veya not…" className="w-full border rounded-xl px-3 py-1.5"/>
              </div>
              <div className="text-sm text-gray-600">
                Toplam <span className="font-semibold">{filtered.length.toLocaleString("tr-TR")}</span> araç •
                Sayfa <span className="font-semibold">{page}</span>/<span className="font-semibold">{pageCount}</span>
              </div>
              <div className="flex gap-1">
                <button onClick={()=>setPage(1)} disabled={page===1} className="px-2 py-1 border rounded disabled:opacity-40">İlk</button>
                <button onClick={()=>setPage(p=>Math.max(1,p-1))} disabled={page===1} className="px-2 py-1 border rounded disabled:opacity-40">Önceki</button>
                <button onClick={()=>setPage(p=>Math.min(pageCount,p+1))} disabled={page===pageCount} className="px-2 py-1 border rounded disabled:opacity-40">Sonraki</button>
                <button onClick={()=>setPage(pageCount)} disabled={page===pageCount} className="px-2 py-1 border rounded disabled:opacity-40">Son</button>
              </div>
            </div>

            <div className="overflow-auto border rounded-2xl">
              <table className="min-w-full text-sm">
                <thead>
                  <tr className="text-left border-b bg-gray-50">
                    <th className="py-2 px-3">Plaka</th>
                    <th className="py-2 px-3">Firma ID</th>
                    <th className="py-2 px-3">Kira Başlangıç</th>
                    <th className="py-2 px-3">Kira Bitiş</th>
                    <th className="py-2 px-3">Yıllık KM Hakkı</th>
                    <th className="py-2 px-3">Ebat</th>
                    <th className="py-2 px-3">Notlar</th>
                    <th className="py-2 px-3">İşlem</th>
                  </tr>
                </thead>
                <tbody>
                  {pageRows.length===0 ? (
                    <tr><td colSpan="8" className="py-6 text-center text-gray-500">Kayıt yok.</td></tr>
                  ) : pageRows.map(a=>(
                    <tr key={a.plaka} className="border-b last:border-0">
                      <td className="py-2 px-3 whitespace-nowrap">{a.plaka}</td>
                      <td className="py-2 px-3 whitespace-nowrap">{a.firma_id}</td>
                      <td className="py-2 px-3 whitespace-nowrap">{a.kira_baslangic}</td>
                      <td className="py-2 px-3 whitespace-nowrap">{a.kira_bitis}</td>
                      <td className="py-2 px-3 whitespace-nowrap">{a.yillik_km_hakki==null ? "Sınırsız" : Number(a.yillik_km_hakki).toLocaleString("tr-TR")}</td>
                      <td className="py-2 px-3 whitespace-nowrap">{a.arac_ebat||"—"}</td>
                      <td className="py-2 px-3">{a.notlar||""}</td>
                      <td className="py-2 px-3">
                        <div className="flex gap-2">
                          <button onClick={()=>openEdit(a)} className="px-2 py-1 rounded-lg border hover:shadow">Düzenle</button>
                          <button onClick={()=>onSil(a.plaka)} className="px-2 py-1 rounded-lg border hover:shadow">Sil</button>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            {editOpen && (
              <div className="fixed inset-0 z-50 bg-black/30 overflow-y-auto flex items-center justify-center p-3">
                <div className="bg-white rounded-2xl shadow-lg p-4 w-full max-w-3xl">
                  <div className="flex items-center justify-between mb-3">
                    <div className="text-lg font-semibold">Araç Düzenle</div>
                    <button onClick={()=>{setEditOpen(false); setEditRow(null);}} className="px-2 py-1 rounded-lg border">Kapat</button>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm">
                    <div>
                      <label className="block text-xs text-gray-600">Plaka</label>
                      <input value={editRow.plaka||""} onChange={e=>setEditRow(r=>({...r,plaka:e.target.value.toUpperCase()}))} className="border rounded-lg px-2 py-1 uppercase"/>
                    </div>
                    <div>
                      <label className="block text-xs text-gray-600">Firma ID</label>
                      <input value={editRow.firma_id||""} onChange={e=>setEditRow(r=>({...r,firma_id:e.target.value}))} className="border rounded-lg px-2 py-1"/>
                    </div>
                    <div>
                      <label className="block text-xs text-gray-600">Kira Başlangıç</label>
                      <input value={editRow.kira_baslangic||""} onChange={e=>setEditRow(r=>({...r,kira_baslangic:e.target.value}))} className="border rounded-lg px-2 py-1" placeholder="gg.aa.yy"/>
                    </div>
                    <div>
                      <label className="block text-xs text-gray-600">Kira Bitiş</label>
                      <input value={editRow.kira_bitis||""} onChange={e=>setEditRow(r=>({...r,kira_bitis:e.target.value}))} className="border rounded-lg px-2 py-1" placeholder="gg.aa.yy"/>
                    </div>
                    <div>
                      <label className="block text-xs text-gray-600">Yıllık KM Hakkı</label>
                      <input value={editRow.yillik_km_hakki??""} onChange={e=>setEditRow(r=>({...r,yillik_km_hakki:e.target.value}))} className="border rounded-lg px-2 py-1" placeholder="Boş bırak = sınırsız"/>
                    </div>
                    <div className="md:col-span-2">
                      <label className="block text-xs text-gray-600">Notlar</label>
                      <input value={editRow.notlar||""} onChange={e=>setEditRow(r=>({...r,notlar:e.target.value}))} className="border rounded-lg px-2 py-1"/>
                    </div>
                    <div className="md:col-span-3">
                      <label className="block text-xs text-gray-600">Lastik Ebatı (Araç)</label>
                      <select value={editRow.arac_ebat||""} onChange={e=>setEditRow(r=>({...r,arac_ebat:e.target.value}))} className="w-full border rounded-lg px-2 py-1">
                        <option value="">— Seçin —</option>
                        <option>135/80 R13</option><option>145/70 R13</option><option>145/80 R13</option>
                        <option>155/65 R13</option><option>155/70 R13</option><option>155/80 R13</option>
                        <option>165/60 R13</option><option>165/65 R13</option><option>165/70 R13</option>
                        <option>175/60 R13</option><option>175/65 R13</option><option>175/70 R13</option>
                        <option>165/60 R14</option><option>165/65 R14</option><option>165/70 R14</option>
                        <option>175/60 R14</option><option>175/65 R14</option><option>175/70 R14</option>
                        <option>185/55 R14</option><option>185/60 R14</option><option>185/65 R14</option><option>185/70 R14</option>
                        <option>195/60 R14</option><option>195/65 R14</option>
                        <option>175/65 R15</option><option>185/55 R15</option><option>185/60 R15</option><option>185/65 R15</option>
                        <option>195/50 R15</option><option>195/55 R15</option><option>195/60 R15</option><option>195/65 R15</option>
                        <option>205/50 R15</option><option>205/55 R15</option><option>205/60 R15</option><option>205/65 R15</option>
                        <option>195/45 R16</option><option>195/50 R16</option><option>195/55 R16</option>
                        <option>205/45 R16</option><option>205/50 R16</option><option>205/55 R16</option>
                        <option>205/60 R16</option><option>205/65 R16</option>
                        <option>215/55 R16</option><option>215/60 R16</option><option>215/65 R16</option>
                        <option>225/50 R16</option><option>225/55 R16</option>
                        <option>205/45 R17</option><option>205/50 R17</option><option>205/55 R17</option>
                        <option>215/45 R17</option><option>215/50 R17</option><option>215/55 R17</option><option>215/60 R17</option>
                        <option>225/45 R17</option><option>225/50 R17</option><option>225/55 R17</option>
                        <option>235/45 R17</option><option>235/55 R17</option>
                        <option>215/40 R18</option><option>215/45 R18</option><option>225/40 R18</option><option>225/45 R18</option>
                        <option>235/40 R18</option><option>235/45 R18</option><option>235/50 R18</option><option>235/55 R18</option>
                        <option>245/40 R18</option><option>245/45 R18</option><option>255/45 R18</option>
                        <option>225/35 R19</option><option>225/40 R19</option><option>235/35 R19</option><option>235/40 R19</option><option>235/45 R19</option>
                        <option>245/40 R19</option><option>255/35 R19</option><option>255/40 R19</option><option>255/45 R19</option><option>275/35 R19</option>
                        <option>235/35 R20</option><option>245/35 R20</option><option>245/40 R20</option><option>255/35 R20</option><option>255/40 R20</option>
                        <option>265/40 R20</option><option>275/35 R20</option><option>275/40 R20</option>
                        <option>245/35 R21</option><option>255/35 R21</option><option>265/40 R21</option><option>275/35 R21</option><option>285/35 R21</option>
                        <option>275/35 R22</option><option>285/35 R22</option><option>295/35 R22</option>
                        <option>185/75 R16C</option><option>195/65 R16C</option><option>195/70 R15C</option><option>195/75 R16C</option>
                        <option>205/65 R16C</option><option>205/70 R15C</option><option>205/75 R16C</option><option>215/65 R16C</option><option>225/65 R16C</option>
                        <option>215/60 R17</option><option>225/60 R17</option><option>235/60 R17</option>
                        <option>225/65 R17</option><option>235/65 R17</option><option>245/65 R17</option>
                        <option>235/55 R18</option><option>235/60 R18</option><option>255/55 R18</option>
                        <option>235/55 R19</option><option>255/50 R19</option><option>255/45 R20</option>
                      </select>
                    </div>
                  </div>
                  <div className="mt-3 flex justify-end gap-2">
                    <button onClick={()=>{setEditOpen(false); setEditRow(null);}} className="px-3 py-1.5 rounded-lg border">Vazgeç</button>
                    <button onClick={saveEdit} className="px-3 py-1.5 rounded-lg bg-emerald-600 text-white">Kaydet</button>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    function App(){
      const [firmalar,setFirmalar]=useState(()=>{try{const s=localStorage.getItem(LS_KEY);return s?(JSON.parse(s).firmalar||[]):[]}catch{return[]}});      
      const [araclar,setAraclar]=useState(()=>{try{const s=localStorage.getItem(LS_KEY);return s?(JSON.parse(s).araclar||[]):[]}catch{return[]}});      
      const [siparisler,setSiparisler]=useState(()=>{try{const s=localStorage.getItem(LS_KEY);return s?(JSON.parse(s).siparisler||[]):[]}catch{return[]}});

      useEffect(()=>{ localStorage.setItem(LS_KEY, JSON.stringify({firmalar,araclar,siparisler})) },[firmalar,araclar,siparisler]);

      useEffect(()=>{
        function syncFromLS(){
          try{
            const cur = JSON.parse(localStorage.getItem(LS_KEY)||'{}');
            Array.isArray(cur.firmalar) && setFirmalar(cur.firmalar);
            Array.isArray(cur.araclar)  && setAraclar(cur.araclar);
            Array.isArray(cur.siparisler)&& setSiparisler(cur.siparisler);
          }catch{}
        }
        window.addEventListener('orders-updated', syncFromLS);
        return ()=>window.removeEventListener('orders-updated', syncFromLS);
      },[]);

      const [sEbat,setSEbat]=useState("");
      const [sPlaka,setSPlaka]=useState("");
      const [sAracKm,setSAracKm]=useState("");
      const [sFirma,setSFirma]=useState("");
      const [sTur,setSTur]=useState("Yaz");
      const [sAdSoyad,setSAdSoyad]=useState("");
      const [sIl,setSIl]=useState("");
      const [sIlce,setSIlce]=useState("");
      const [sIrtibat,setSIrtibat]=useState("");
      const [sEmail,setSEmail]=useState("");

      const [sorguPlaka,setSorguPlaka]=useState("");

      const [firmaId,setFirmaId]=useState(""),[baslangic,setBaslangic]=useState(""),[bitis,setBitis]=useState(""),[yillikKm,setYillikKm]=useState(""),[sinirsiz,setSinirsiz]=useState(false);

      const fileRef=useRef(null), xlsxRef=useRef(null), siparisXlsxRef=useRef(null);

      const [userInfo,setUserInfo]=useState({email:"",name:""});

      const firmaMap = useMemo(()=> new Map(firmalar.map(f=>[f.id,f.ad])), [firmalar]);
      const seciliArac = useMemo(()=>{
        const p=(sorguPlaka||"").trim().toUpperCase();
        return araclar.find(a=>a.plaka===p)||null;
      },[sorguPlaka,araclar]);

      function siparisEkle(e){
        e.preventDefault();
        const p=(sPlaka||"").trim().toUpperCase();
        const ebat=(sEbat||"").trim();
        const kmRaw=(sAracKm||"").toString().trim();
        const km=Number.parseInt(kmRaw.replace(/\D/g,''))||0;
        const firma=(sFirma||"").trim();
        const tur=(sTur||"Yaz");
        if(!ebat) return alert("Ebat seçin");
        if(!p) return alert("Plaka girin");
        if(!firma) return alert("Firma girin");
        const id=Date.now().toString();
        const row={id,tarih:today(),plaka:p.toUpperCase(),ebat,arac_km:km,firma:(firma||"").toUpperCase(),tur:(tur||"").toUpperCase(),ad_soyad:(sAdSoyad||"").toUpperCase(),il:(sIl||"").toUpperCase(),ilce:(sIlce||"").toUpperCase(),irtibat_no:sIrtibat,email:window.emailNormalize(sEmail),createdBy:userInfo.email||"",createdByName:userInfo.name||""};
        setSiparisler(prev=>[row,...prev]);
        setSorguPlaka(p);
        setSEbat(""); setSPlaka(""); setSAracKm(""); setSFirma(""); setSTur("Yaz");
        setSAdSoyad(""); setSIl(""); setSIlce(""); setSIrtibat(""); setSEmail("");
        try{ window.pushOrder && window.pushOrder(row); }catch{}
      }
      function siparisSil(id){ if(!confirm("Silinsin mi?")) return; setSiparisler(prev=>prev.filter(s=>s.id!==id)); try{ window.deleteOrderById && window.deleteOrderById(id); }catch{} }

      function exportCSV(){
        const hdr=["plaka","firma_id","kira_baslangic","kira_bitis","yillik_km_hakki","arac_ebat","notlar"];
        const rows=[hdr.join(",")];
        for(const a of araclar){
          rows.push([csvSafe(a.plaka),csvSafe(a.firma_id),csvSafe(a.kira_baslangic),csvSafe(a.kira_bitis),csvSafe(a.yillik_km_hakki==null?"":a.yillik_km_hakki),csvSafe(a.arac_ebat||""),csvSafe((a.notlar||"").replaceAll(",",";"))].join(","));
        }
        download("araclar.csv",rows.join("\n"));
      }
      function exportJSON(){ download("veri.json", JSON.stringify({firmalar,araclar,siparisler},null,2)); }
      function importJSON(ev){
        const f=ev.target.files?.[0]; if(!f) return;
        const fr=new FileReader(); fr.onload=()=>{ try{
          const d=JSON.parse(String(fr.result||"{}"));
          if(Array.isArray(d.firmalar)) setFirmalar(d.firmalar);
          if(Array.isArray(d.araclar)) setAraclar(d.araclar);
          if(Array.isArray(d.siparisler)) setSiparisler(d.siparisler);
        }catch(e){ alert("JSON okunamadı: "+e.message) } finally{ ev.target.value=""; } }; fr.readAsText(f,"utf-8");
      }
      function importXLSX(ev){
        const f=ev.target.files?.[0]; if(!f) return;
        const fr=new FileReader(); fr.onload=()=>{ try{
          const wb=XLSX.read(new Uint8Array(fr.result),{type:"array"});
          const wsF=wb.Sheets["Firmalar"]||wb.Sheets["firmalar"]; let yeniF=[];
          if(wsF){ yeniF=XLSX.utils.sheet_to_json(wsF,{defval:""}).map(r=>({id:String(r.id||"").trim(), ad:String(r.ad||"").trim()})).filter(x=>x.id&&x.ad); }
          const wsA=wb.Sheets["Araclar"]||wb.Sheets["araclar"]; let yeniA=[];
          if(wsA){
            yeniA=XLSX.utils.sheet_to_json(wsA,{defval:""}).map(r=>{
              const yk=String(r.yillik_km_hakki??"").trim();
              const ykVal = yk==="" ? null : (Number.isFinite(Number(yk))?Math.floor(Number(yk)):null);
              return {plaka:String(r.plaka||"").trim().toUpperCase(),
                      firma_id:String(r.firma_id||"").trim(),
                      kira_baslangic:normExcelDate(r.kira_baslangic),
                      kira_bitis:normExcelDate(r.kira_bitis),
                      yillik_km_hakki: ykVal,
                      arac_ebat:String(r.arac_ebat||r.ebat||"").trim(),
                      notlar:String(r.notlar||"").trim()};
            }).filter(a=>a.plaka&&a.firma_id&&a.kira_baslangic&&a.kira_bitis);
          }
          if(yeniF.length){ const m=new Map(firmalar.map(f=>[f.id,f])); yeniF.forEach(f=>m.set(f.id,f)); setFirmalar([...m.values()].sort((a,b)=>a.id.localeCompare(b.id))); }
          if(yeniA.length){ const m=new Map(araclar.map(a=>[a.plaka,a])); yeniA.forEach(a=>m.set(a.plaka,a)); setAraclar([...m.values()].sort((a,b)=>a.plaka.localeCompare(b.plaka))); }
          if(!yeniF.length && !yeniA.length) alert("Excel'de 'Firmalar' ve/veya 'Araclar' sayfaları yok.");
        }catch(e){ alert("Excel okunamadı: "+e.message) } finally{ ev.target.value=""; } }; fr.readAsArrayBuffer(f);
      }
      function importSiparisXLSX(ev){
        const f=ev.target.files?.[0]; if(!f) return;
        const fr=new FileReader(); fr.onload=()=>{ try{
          const wb=XLSX.read(new Uint8Array(fr.result),{type:"array"});
          const wsS=wb.Sheets["Siparisler"]||wb.Sheets["SİPARİŞLER"]||wb.Sheets["siparisler"];
          if(!wsS){ alert("Excel'de 'Siparisler' sayfası bulunamadı."); return; }
          const raw = XLSX.utils.sheet_to_json(wsS,{defval:""});
          let ok=0, fail=0;
          const normalizeTur = (v)=>{ const n=String(v||"").trim().toLowerCase().normalize('NFC').replace(/ı/g,'i'); return n.startsWith("k") ? "KIŞ" : "YAZ"; };
          const toInt=(v)=>{ try{ const n=Number.parseInt(String(v).replace(/\D/g,'')); return Number.isFinite(n)?n:0; }catch{ return 0; } };
          for(const r of raw){
            try{
              const row={ tarih:normExcelDate(r["Tarih"]), plaka:String(r["Plaka"]||"").trim().toUpperCase(), ebat:String(r["Ebat"]||"").trim(),
                          arac_km:toInt(r["Araç KM"]), firma:String(r["Firma"]||"").trim().toUpperCase(), tur:normalizeTur(r["Tür"]),
                          ad_soyad:String(r["İsim Soyisim"]||"").trim().toUpperCase(), il:String(r["İl"]||"").trim().toUpperCase(),
                          ilce:String(r["İlçe"]||"").trim(), irtibat_no:String(r["İrtibat"]||"").trim(),
                          email: window.emailNormalize ? window.emailNormalize(r["E-posta"]||"") : String(r["E-posta"]||"").trim() };
              if(!row.tarih || !row.plaka || !row.ebat){ fail++; continue; }
              window.pushOrder && window.pushOrder(row); ok++;
            }catch{ fail++; }
          }
          alert(`Yükleme tamamlandı. Başarılı: ${ok}, Hatalı: ${fail}`);
        }catch(e){ alert("Excel okunamadı: "+e.message) } finally{ ev.target.value=""; } };
        fr.readAsArrayBuffer(f);
      }

      const [sfBas,setSfBas]=useState(""),[sfBit,setSfBit]=useState(""),[sfPlaka,setSfPlaka]=useState(""),[sfFirma,setSfFirma]=useState(""),[sfTur,setSfTur]=useState(""),[sfEbat,setSfEbat]=useState("");
      const filtered = useMemo(()=>{
        const s=toDate(sfBas), e=toDate(sfBit); const N=x=>String(x||"").toUpperCase();
        const fPl=N(sfPlaka), fFi=N(sfFirma), fEb=N(sfEbat), fT=N(sfTur);
        return siparisler.filter(x=>{
          const d=toDate(x.tarih); if(!d) return false;
          if(s&&d<s) return false; if(e&&d>e) return false;
          if(fPl && !N(x.plaka).includes(fPl)) return false;
          if(fFi && !N(x.firma||"").includes(fFi)) return false;
          if(fT && N(x.tur)!==fT) return false;
          if(fEb && !N(x.ebat).includes(fEb)) return false;
          return true;
        });
      },[siparisler,sfBas,sfBit,sfPlaka,sfFirma,sfTur,sfEbat]);

      const pageSize = 50;
      const [page, setPage] = useState(1);
      const pageCount = useMemo(()=> Math.max(1, Math.ceil(filtered.length / pageSize)), [filtered.length]);
      useEffect(()=>{ setPage(1); }, [sfBas,sfBit,sfPlaka,sfFirma,sfTur,sfEbat,siparisler]);
      const pageRows = useMemo(()=>{ const start = (page-1)*pageSize; return filtered.slice(start, start + pageSize); },[filtered,page]);

      const siparisOzet = useMemo(()=>{
        const p=(sorguPlaka||"").trim().toUpperCase(); let yaz=0,kis=0;
        if(!p) return {yaz,kis};
        for(const s of siparisler){ if(String(s.plaka).toUpperCase()===p){ normalizeTR(s.tur||'Yaz')==='kis' ? kis++ : yaz++; } }
        return {yaz,kis};
      },[sorguPlaka,siparisler]);

      const [editOpen,setEditOpen]=useState(false);
      const [editRow,setEditRow]=useState(null);
      function openEdit(row){ setEditRow({...row}); setEditOpen(true); }
      function closeEdit(){ setEditOpen(false); setEditRow(null); }
      async function saveEdit(){
        if(!editRow?.id) return;
        const patch = {
          tarih: editRow.tarih, plaka: String(editRow.plaka||"").toUpperCase(), ebat: String(editRow.ebat||""),
          arac_km: Number.parseInt(editRow.arac_km||0)||0, firma: String(editRow.firma||"").toUpperCase(),
          tur: String(editRow.tur||"").toUpperCase(), ad_soyad: String(editRow.ad_soyad||"").toUpperCase(),
          il: String(editRow.il||"").toUpperCase(), ilce: String(editRow.ilce||""), irtibat_no: String(editRow.irtibat_no||""),
          email: window.emailNormalize ? window.emailNormalize(editRow.email||"") : (editRow.email||"")
        };
        try{ window.updateOrderById && await window.updateOrderById(editRow.id, patch);
             setSiparisler(prev=>prev.map(x=>x.id===editRow.id?{...x,...patch}:x)); closeEdit(); }
        catch(e){ alert("Güncellenemedi: "+(e.message||e)); }
      }

      const [showAracPanel, setShowAracPanel] = useState(false);
      function aracSil(plaka){ if(!confirm("Bu aracı silmek istiyor musunuz?")) return; setAraclar(prev => prev.filter(a => a.plaka !== plaka)); }
      function aracKaydet(originalPlaka, data){
        const yeni = {
          plaka: String(data.plaka||"").trim().toUpperCase(),
          firma_id: String(data.firma_id||"").trim(),
          kira_baslangic: String(data.kira_baslangic||"").trim(),
          kira_bitis: String(data.kira_bitis||"").trim(),
          yillik_km_hakki: data.yillik_km_hakki==='' ? null : (Number.isFinite(Number(data.yillik_km_hakki)) ? Math.floor(Number(data.yillik_km_hakki)) : null),
          arac_ebat: String(data.arac_ebat||"").trim(),
          notlar: String(data.notlar||"").trim()
        };
        if(!yeni.plaka || !yeni.firma_id || !yeni.kira_baslangic || !yeni.kira_bitis){ alert("Plaka, firma_id, kira başlangıç ve kira bitiş zorunludur."); return false; }
        setAraclar(prev=>{ const m = new Map(prev.map(a=>[a.plaka,a])); if(originalPlaka && originalPlaka!==yeni.plaka) m.delete(originalPlaka); m.set(yeni.plaka, yeni); return [...m.values()].sort((a,b)=>a.plaka.localeCompare(b.plaka)); });
        return true;
      }

      return (
        <div className="min-h-screen">
          <header className="sticky top-0 z-10 bg-emerald-600 text-white">
            <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
              <h1 className="text-2xl font-bold">SEKAR FİLO LASTİK HAK TAKİP</h1>
              <div className="flex items-center gap-3">
                {userInfo.email && (<div className="text-xs bg-white/15 px-3 py-1.5 rounded-xl">{userInfo.name||userInfo.email}</div>)}
                <div className="flex gap-2">
                  <button onClick={exportCSV} className="px-3 py-1.5 rounded-xl border border-white text-white/90 hover:bg-white/10">CSV</button>
                  <button onClick={exportJSON} className="px-3 py-1.5 rounded-xl border border-white text-white/90 hover:bg-white/10">JSON</button>
                  <input ref={fileRef} type="file" accept="application/json" onChange={importJSON} className="hidden"/>
                  <button onClick={()=>fileRef.current?.click()} className="px-3 py-1.5 rounded-xl border border-white text-white/90 hover:bg-white/10">JSON İçe Al</button>
                  <input ref={xlsxRef} type="file" accept=".xlsx,.xls" onChange={importXLSX} className="hidden"/>
                  <button onClick={()=>xlsxRef.current?.click()} className="px-3 py-1.5 rounded-xl border border-white text-white/90 hover:bg-white/10">Excel İçe Al</button>
                  <input ref={siparisXlsxRef} type="file" accept=".xlsx,.xls" onChange={importSiparisXLSX} className="hidden"/>
                  <button onClick={()=>siparisXlsxRef.current?.click()} className="px-3 py-1.5 rounded-xl border border-white text-white/90 hover:bg-white/10">Excel’den Sipariş Yükle</button>
                  <button onClick={()=>setShowAracPanel(true)} className="px-3 py-1.5 rounded-xl border border-white text-white/90 hover:bg-white/10">Araç Bilgisi</button>
                  <button onClick={()=>window.signOut && window.signOut()} className="px-3 py-1.5 rounded-xl border border-white text-white/90 hover:bg-white/10">Çıkış</button>
                </div>
              </div>
            </div>
          </header>

          <main className="max-w-7xl mx-auto p-4 grid grid-cols-1 gap-4">
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 items-stretch">
              <div className="bg-white rounded-2xl p-4 shadow h-full">
                <h2 className="text-lg font-semibold mb-3">Lastik Siparişi</h2>
                <form onSubmit={siparisEkle} className="space-y-3">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                    <div>
                      <label className="block text-xs font-medium text-gray-600 mb-0.5">Lastik Ebatı</label>
                      <select value={sEbat} onChange={e=>setSEbat(e.target.value)} className="mt-1 w-full rounded-lg border px-2 py-1 text-sm">
                        <option value="">— Seçin —</option>
                        <option>135/80 R13</option><option>145/70 R13</option><option>145/80 R13</option>
                        <option>155/65 R13</option><option>155/70 R13</option><option>155/80 R13</option>
                        <option>165/60 R13</option><option>165/65 R13</option><option>165/70 R13</option>
                        <option>175/60 R13</option><option>175/65 R13</option><option>175/70 R13</option>
                        <option>165/60 R14</option><option>165/65 R14</option><option>165/70 R14</option>
                        <option>175/60 R14</option><option>175/65 R14</option><option>175/70 R14</option>
                        <option>185/55 R14</option><option>185/60 R14</option><option>185/65 R14</option><option>185/70 R14</option>
                        <option>195/60 R14</option><option>195/65 R14</option>
                        <option>175/65 R15</option><option>185/55 R15</option><option>185/60 R15</option><option>185/65 R15</option>
                        <option>195/50 R15</option><option>195/55 R15</option><option>195/60 R15</option><option>195/65 R15</option>
                        <option>205/50 R15</option><option>205/55 R15</option><option>205/60 R15</option><option>205/65 R15</option>
                        <option>195/45 R16</option><option>195/50 R16</option><option>195/55 R16</option>
                        <option>205/45 R16</option><option>205/50 R16</option><option>205/55 R16</option>
                        <option>205/60 R16</option><option>205/65 R16</option>
                        <option>215/55 R16</option><option>215/60 R16</option><option>215/65 R16</option>
                        <option>225/50 R16</option><option>225/55 R16</option>
                        <option>205/45 R17</option><option>205/50 R17</option><option>205/55 R17</option>
                        <option>215/45 R17</option><option>215/50 R17</option><option>215/55 R17</option><option>215/60 R17</option>
                        <option>225/45 R17</option><option>225/50 R17</option><option>225/55 R17</option>
                        <option>235/45 R17</option><option>235/55 R17</option>
                        <option>215/40 R18</option><option>215/45 R18</option><option>225/40 R18</option><option>225/45 R18</option>
                        <option>235/40 R18</option><option>235/45 R18</option><option>235/50 R18</option><option>235/55 R18</option>
                        <option>245/40 R18</option><option>245/45 R18</option><option>255/45 R18</option>
                        <option>225/35 R19</option><option>225/40 R19</option><option>235/35 R19</option><option>235/40 R19</option><option>235/45 R19</option>
                        <option>245/40 R19</option><option>255/35 R19</option><option>255/40 R19</option><option>255/45 R19</option><option>275/35 R19</option>
                        <option>235/35 R20</option><option>245/35 R20</option><option>245/40 R20</option><option>255/35 R20</option><option>255/40 R20</option>
                        <option>265/40 R20</option><option>275/35 R20</option><option>275/40 R20</option>
                        <option>245/35 R21</option><option>255/35 R21</option><option>265/40 R21</option><option>275/35 R21</option><option>285/35 R21</option>
                        <option>275/35 R22</option><option>285/35 R22</option><option>295/35 R22</option>
                        <option>185/75 R16C</option><option>195/65 R16C</option><option>195/70 R15C</option><option>195/75 R16C</option>
                        <option>205/65 R16C</option><option>205/70 R15C</option><option>205/75 R16C</option><option>215/65 R16C</option><option>225/65 R16C</option>
                        <option>215/60 R17</option><option>225/60 R17</option><option>235/60 R17</option>
                        <option>225/65 R17</option><option>235/65 R17</option><option>245/65 R17</option>
                        <option>235/55 R18</option><option>235/60 R18</option><option>255/55 R18</option>
                        <option>235/55 R19</option><option>255/50 R19</option><option>255/45 R20</option>
                      </select>
                    </div>
                    <div><label className="block text-xs font-medium text-gray-600">Plaka</label><input value={sPlaka} onChange={e=>setSPlaka(e.target.value.toUpperCase())} placeholder="34ABC123" className="mt-1 w-full rounded-lg border px-2 py-1 uppercase tracking-wide"/></div>
                    <div><label className="block text-xs font-medium text-gray-600">Araç KM</label><input value={sAracKm} onChange={e=>setSAracKm(e.target.value)} placeholder="Örn: 120000" className="mt-1 w-full rounded-lg border px-2 py-1 text-sm"/></div>
                    <div><label className="block text-xs font-medium text-gray-600">Lastik Firması</label><input value={sFirma} onChange={e=>setSFirma(e.target.value)} placeholder="Örn: LastikCo" className="mt-1 w-full rounded-lg border px-2 py-1 text-sm"/></div>
                    <div><label className="block text-xs font-medium text-gray-600">Tür</label><select value={sTur} onChange={e=>setSTur(e.target.value)} className="mt-1 w-full rounded-lg border px-2 py-1 text-sm"><option>Yaz</option><option>Kış</option></select></div>
                    <div><label className="block text-xs font-medium text-gray-600">İsim Soyisim</label><input value={sAdSoyad} onChange={e=>setSAdSoyad(e.target.value)} placeholder="Örn: Ali Veli" className="mt-1 w-full rounded-lg border px-2 py-1 text-sm"/></div>
                    <div><label className="block text-xs font-medium text-gray-600">İl</label>
                      <select value={sIl} onChange={e=>setSIl(e.target.value)} className="mt-1 w-full rounded-lg border px-2 py-1 text-sm">
                        <option value="">İl (Seçin)</option>{TR_ILLER.map((il,i)=>(<option key={i} value={il}>{il}</option>))}
                      </select></div>
                    <div><label className="block text-xs font-medium text-gray-600">İlçe</label><input value={sIlce} onChange={e=>setSIlce(e.target.value)} placeholder="İlçe" className="mt-1 w-full rounded-lg border px-2 py-1 text-sm"/></div>
                    <div><label className="block text-xs font-medium text-gray-600">İrtibat No</label><input value={sIrtibat} onChange={e=>setSIrtibat(e.target.value)} placeholder="5xx xxx xx xx" className="mt-1 w-full rounded-lg border px-2 py-1 text-sm"/></div>
                    <div><label className="block text-xs font-medium text-gray-600">E-posta</label><input type="email" value={sEmail} onChange={e=>setSEmail(e.target.value)} placeholder="ornek@mail.com" className="mt-1 w-full rounded-lg border px-2 py-1 text-sm"/></div>
                  </div>
                  <div className="mt-2 md:col-span-2"><button className="w-full py-2 text-sm rounded-lg bg-emerald-600 text-white hover:opacity-95">Sipariş Ekle</button></div>
                </form>
              </div>

              <div className="bg-white rounded-2xl p-4 shadow h-full">
                <h2 className="text-lg font-semibold mb-3">Canlı Önizleme</h2>
                <PreviewCard
                  temp={{
                    plaka:(sorguPlaka||"").toUpperCase(),
                    firma_ad: (()=>{
                      if(seciliArac) return (firmaMap.get(seciliArac.firma_id)||seciliArac.firma_id);
                      return (firmaMap.get(firmaId)||firmaId||"—");
                    })(),
                    kira_baslangic: seciliArac ? seciliArac.kira_baslangic : (baslangic || "—"),
                    kira_bitis: seciliArac ? seciliArac.kira_bitis : (bitis || "—"),
                    arac_ebat: (seciliArac && seciliArac.arac_ebat) ? seciliArac.arac_ebat : (sEbat || "—"),
                    yillik_km: seciliArac ? (seciliArac.yillik_km_hakki===null?null:seciliArac.yillik_km_hakki) : (sinirsiz?null:(Number.parseInt(yillikKm)||0)),
                    tahmini_km: (()=>{
                      const s=seciliArac?seciliArac.kira_baslangic:baslangic, e=seciliArac?seciliArac.kira_bitis:bitis, y=seciliArac?seciliArac.yillik_km_hakki:(sinirsiz?null:(Number.parseInt(yillikKm)||0));
                      return y===null?200000:Math.round(prorata(y,s||"",e||""));
                    })(),
                    kis_hakki:(seciliArac?1:(baslangic&&bitis?1:0)),
                    yaz_hakki:(()=>{
                      const s=seciliArac?seciliArac.kira_baslangic:baslangic, e=seciliArac?seciliArac.kira_bitis:bitis, y=seciliArac?seciliArac.yillik_km_hakki:(sinirsiz?null:(Number.parseInt(yillikKm)||0));
                      const t=(y===null)?200000:Math.round(prorata(y,s||"",e||"")); return Math.floor(Math.max(0,t)/50000);
                    })(),
                  }}
                  queryPlaka={sorguPlaka}
                  onQueryChange={setSorguPlaka}
                  orderCounts={siparisOzet}
                />
              </div>
            </div>

            <div className="bg-white rounded-2xl p-3 shadow">
              <div className="flex items-center justify-between mb-3 gap-2 flex-wrap">
                <h2 className="text-lg font-semibold">Siparişler</h2>
                <div className="flex items-end gap-2 flex-wrap">
                  <div><label className="block text-xs text-gray-500">Başlangıç</label><input value={sfBas} onChange={e=>setSfBas(e.target.value)} placeholder="01.01.25" className="border rounded-xl px-3 py-1.5"/></div>
                  <div><label className="block text-xs text-gray-500">Bitiş</label><input value={sfBit} onChange={e=>setSfBit(e.target.value)} placeholder="31.12.25" className="border rounded-xl px-3 py-1.5"/></div>
                  <div><label className="block text-xs text-gray-500">Plaka</label><input value={sfPlaka} onChange={e=>setSfPlaka(e.target.value)} placeholder="34ABC123" className="border rounded-xl px-3 py-1.5 uppercase"/></div>
                  <div><label className="block text-xs text-gray-500">Lastik Firması</label><input value={sfFirma} onChange={e=>setSfFirma(e.target.value)} placeholder="Firma ara…" className="border rounded-xl px-3 py-1.5"/></div>
                  <div><label className="block text-xs text-gray-500">Tür</label><select value={sfTur} onChange={e=>setSfTur(e.target.value)} className="border rounded-xl px-3 py-1.5"><option value="">Hepsi</option><option value="Yaz">Yaz</option><option value="Kış">Kış</option></select></div>
                  <div>
                    <label className="block text-xs text-gray-500">Ebat</label>
                    {/* Otomatik e-posta doldurmasını engellemek için autocomplete kapalı */}
                    <input value={sfEbat} onChange={e=>setSfEbat(e.target.value)} placeholder="205/55 R16" autoComplete="off" name="sfEbat" className="border rounded-xl px-3 py-1.5"/>
                  </div>
                  <button onClick={()=>{setSfBas("");setSfBit("");setSfPlaka("");setSfFirma("");setSfTur("");setSfEbat("");}} className="px-3 py-1.5 rounded-xl border shadow-sm">Filtreyi Temizle</button>
                  <button onClick={()=>{
                    const src = (Array.isArray(filtered) && filtered.length ? filtered : pageRows);
                    const rows = src.map(s=>({Tarih:s.tarih,Plaka:s.plaka,Ebat:s.ebat,"Araç KM":Number.parseInt(s.arac_km||0)||0,Firma:(s.firma||""),Tür:s.tur,"İsim Soyisim":(s.ad_soyad||""),"İl":(s.il||""),"İlçe":(s.ilce||""),"İrtibat":(s.irtibat_no||""),"E-posta":window.emailNormalize(s.email||"")}));
                    if(!rows.length) return alert("Filtreye uyan sipariş yok.");
                    const ws=XLSX.utils.json_to_sheet(rows), wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Siparisler"); XLSX.writeFile(wb,"siparisler.xlsx");
                  }} className="px-3 py-1.5 rounded-xl border shadow-sm">Excel'e Aktar</button>
                </div>
              </div>

              <div className="flex items-center justify-between mb-2 text-sm">
                <div className="text-gray-600">
                  Toplam <span className="font-semibold">{filtered.length.toLocaleString("tr-TR")}</span> kayıt •
                  Sayfa <span className="font-semibold">{page}</span>/<span className="font-semibold">{pageCount}</span> •
                  Sayfa başı <span className="font-semibold">50</span>
                </div>
                <div className="flex gap-1">
                  <button onClick={()=>setPage(1)} disabled={page===1} className="px-2 py-1 border rounded disabled:opacity-40">İlk</button>
                  <button onClick={()=>setPage(p=>Math.max(1,p-1))} disabled={page===1} className="px-2 py-1 border rounded disabled:opacity-40">Önceki</button>
                  <button onClick={()=>setPage(p=>Math.min(pageCount,p+1))} disabled={page===pageCount} className="px-2 py-1 border rounded disabled:opacity-40">Sonraki</button>
                  <button onClick={()=>setPage(pageCount)} disabled={page===pageCount} className="px-2 py-1 border rounded disabled:opacity-40">Son</button>
                </div>
              </div>

              {pageRows.length===0 ? <p className="text-sm text-gray-600">Henüz sipariş yok.</p> :
                <div className="overflow-auto">
                  <table className="min-w-full text-sm">
                    <thead><tr className="text-left border-b">
                      <th className="py-2 pr-4">Tarih</th><th className="py-2 pr-4">Plaka</th><th className="py-2 pr-4">Ebat</th>
                      <th className="py-2 pr-4">Araç KM</th><th className="py-2 pr-4">Firma</th><th className="py-2 pr-4">Tür</th><th className="py-2 pr-4">İsim Soyisim</th><th className="py-2 pr-4">İl</th><th className="py-2 pr-4">İlçe</th><th className="py-2 pr-4">İrtibat</th><th className="py-2 pr-4">E-posta</th><th className="py-2 pr-4">İşlem</th>
                    </tr></thead>
                    <tbody>
                      {pageRows.map(s=>(
                        <tr key={s.id} className="border-b last:border-0">
                          <td className="py-2 pr-4 whitespace-nowrap">{s.tarih}</td>
                          <td className="py-2 pr-4 whitespace-nowrap"><button className="underline" onClick={()=>setSorguPlaka(s.plaka)}>{s.plaka}</button></td>
                          <td className="py-2 pr-4 whitespace-nowrap">{s.ebat}</td>
                          <td className="py-2 pr-4 whitespace-nowrap">{(Number.parseInt(s.arac_km||0)||0).toLocaleString("tr-TR")}</td>
                          <td className="py-2 pr-4 whitespace-nowrap">{s.firma||""}</td>
                          <td className="py-2 pr-4 whitespace-nowrap">{s.tur}</td>
                          <td className="py-2 pr-4 whitespace-nowrap">{s.ad_soyad||""}</td>
                          <td className="py-2 pr-4 whitespace-nowrap">{s.il||""}</td>
                          <td className="py-2 pr-4 whitespace-nowrap">{s.ilce||""}</td>
                          <td className="py-2 pr-4 whitespace-nowrap">{s.irtibat_no||""}</td>
                          <td className="py-2 pr-4 whitespace-nowrap">{window.emailNormalize(s.email||"")}</td>
                          <td className="py-2 pr-4">
                            <div className="flex gap-2">
                              <button onClick={()=>openEdit(s)} className="px-2 py-1 rounded-lg border hover:shadow">Düzenle</button>
                              <button onClick={()=>siparisSil(s.id)} className="px-2 py-1 rounded-lg border hover:shadow">Sil</button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>}
            </div>
          </main>

          {showAracPanel && (
            <AracPanel
              araclar={araclar}
              onClose={()=>setShowAracPanel(false)}
              onImportXLSX={importXLSX}
              onSil={aracSil}
              onKaydet={aracKaydet}
            />
          )}

          {editOpen && (
            <div className="fixed inset-0 z-50 bg-black/30 overflow-y-auto flex items-center justify-center p-3">
              <div className="bg-white rounded-2xl shadow-lg p-4 w-full max-w-3xl">
                <div className="flex items-center justify-between mb-3">
                  <div className="text-lg font-semibold">Siparişi Düzenle</div>
                  <button onClick={closeEdit} className="px-2 py-1 rounded-lg border">Kapat</button>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm">
                  <div><label className="block text-xs text-gray-600">Tarih</label><input value={editRow.tarih||""} onChange={e=>setEditRow(r=>({...r,tarih:e.target.value}))} className="border rounded-lg px-2 py-1"/></div>
                  <div><label className="block text-xs text-gray-600">Plaka</label><input value={editRow.plaka||""} onChange={e=>setEditRow(r=>({...r,plaka:e.target.value.toUpperCase()}))} className="border rounded-lg px-2 py-1 uppercase"/></div>
                  <div><label className="block text-xs text-gray-600">Ebat</label><input value={editRow.ebat||""} onChange={e=>setEditRow(r=>({...r,ebat:e.target.value}))} className="border rounded-lg px-2 py-1"/></div>
                  <div><label className="block text-xs text-gray-600">Araç KM</label><input value={editRow.arac_km||""} onChange={e=>setEditRow(r=>({...r,arac_km:e.target.value}))} className="border rounded-lg px-2 py-1"/></div>
                  <div><label className="block text-xs text-gray-600">Firma</label><input value={editRow.firma||""} onChange={e=>setEditRow(r=>({...r,firma:e.target.value}))} className="border rounded-lg px-2 py-1"/></div>
                  <div><label className="block text-xs text-gray-600">Tür</label>
                    <select value={editRow.tur||"YAZ"} onChange={e=>setEditRow(r=>({...r,tur:e.target.value}))} className="border rounded-lg px-2 py-1">
                      <option>YAZ</option><option>KIŞ</option>
                    </select></div>
                  <div><label className="block text-xs text-gray-600">İsim Soyisim</label><input value={editRow.ad_soyad||""} onChange={e=>setEditRow(r=>({...r,ad_soyad:e.target.value}))} className="border rounded-lg px-2 py-1"/></div>
                  <div><label className="block text-xs text-gray-600">İl</label><input value={editRow.il||""} onChange={e=>setEditRow(r=>({...r,il:e.target.value}))} className="border rounded-lg px-2 py-1"/></div>
                  <div><label className="block text-xs text-gray-600">İlçe</label><input value={editRow.ilce||""} onChange={e=>setEditRow(r=>({...r,ilce:e.target.value}))} className="border rounded-lg px-2 py-1"/></div>
                  <div><label className="block text-xs text-gray-600">İrtibat</label><input value={editRow.irtibat_no||""} onChange={e=>setEditRow(r=>({...r,irtibat_no:e.target.value}))} className="border rounded-lg px-2 py-1"/></div>
                  <div className="md:col-span-2"><label className="block text-xs text-gray-600">E-posta</label><input value={editRow.email||""} onChange={e=>setEditRow(r=>({...r,email:e.target.value}))} className="border rounded-lg px-2 py-1"/></div>
                </div>
                <div className="mt-3 flex justify-end gap-2">
                  <button onClick={closeEdit} className="px-3 py-1.5 rounded-lg border">Vazgeç</button>
                  <button onClick={saveEdit} className="px-3 py-1.5 rounded-lg bg-emerald-600 text-white">Kaydet</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function PreviewCard({temp, queryPlaka, onQueryChange, orderCounts}){
      const valid = temp.kira_baslangic!=="—" && temp.kira_bitis!=="—" && temp.plaka;
      return (
        <div className="rounded-2xl border p-4 grid md:grid-cols-2 gap-4">
          <div>
            <div className="text-sm text-gray-500 mb-1">Önizleme</div>
            <input value={queryPlaka} onChange={e=>onQueryChange(e.target.value.toUpperCase())} placeholder="PLAKA YAZIN (örn: 34ABC123)" className="w-full bg-transparent outline-none font-semibold text-xl uppercase tracking-wide border-b border-dashed focus:border-gray-400"/>
            <div className="text-sm mt-1">{temp.firma_ad}</div>
            <div className="mt-3 grid grid-cols-2 gap-3 text-sm">
              <div><div className="text-gray-500">Başlangıç</div><div className="font-medium">{temp.kira_baslangic}</div></div>
              <div><div className="text-gray-500">Bitiş</div><div className="font-medium">{temp.kira_bitis}</div></div>

              {/* İSTEK: Ebat satırında Tahmini Dönem KM gösteriliyor */}
              

              <div><div className="text-gray-500">Yıllık KM</div><div className="font-medium">{temp.yillik_km==null?"Sınırsız":Number(temp.yillik_km).toLocaleString("tr-TR")}</div></div>
<div>
  <div className="text-gray-500">Tahmini Dönem KM</div>
  <div className="font-medium">{Number(temp.tahmini_km||0).toLocaleString("tr-TR")}</div>
</div>
<div>
  <div className="text-gray-500">Yaz Lastiği Hakkı</div>
  <div className="font-medium">{valid ? temp.yaz_hakki : 0}</div>
</div>
<div>
  <div className="text-gray-500">Ebat</div>
  <div className="font-medium">{temp.arac_ebat||"—"}</div>
</div>


              {/* İSTEK: Tahmini Dönem KM satırında Yaz Lastiği Hakkı gösteriliyor */}
              

              <div><div className="text-gray-500">Kış Lastiği Hakkı</div><div className="font-medium">{valid?temp.kis_hakki:0}</div></div>

              {/* İSTEK: Yaz Lastiği Hakkı satırında Ebat (arac_ebat) gösteriliyor */}
              
            </div>
          </div>
          <div className="self-center">
            <div className="mt-0 p-3 bg-amber-50 rounded-xl border border-amber-200 text-sm">
              <div className="font-semibold mb-1">Bu plaka için verilen siparişler</div>
              <div className="flex gap-6"><div>Kış: <span className="font-semibold">{orderCounts.kis}</span></div><div>Yaz: <span className="font-semibold">{orderCounts.yaz}</span></div></div>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
  (function(){
    const LS_KEY = "lastik_takip_v1";
    const COLL   = "lastik_siparisleri";
    const firebaseConfig = {
      apiKey: "AIzaSyB-xEmeTVN8oiB4FZzV4UpJpAHkyDHYF4U",
      authDomain: "sekar-filo.firebaseapp.com",
      projectId: "sekar-filo",
      storageBucket: "sekar-filo.appspot.com",
      messagingSenderId: "61274893830",
      appId: "1:61274893830:web:c9dfdf8baf0500178f9d87"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();
    const ORD  = db.collection(COLL);
    const USERS = db.collection("users");

    const ov = document.createElement('div');
    ov.style.cssText="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.08);backdrop-filter:blur(2px);z-index:99999";
    ov.innerHTML = '<div style="background:#fff;padding:18px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.2);width:340px;font-family:system-ui">'+
      '<h3 style="margin:0 0 8px;font-size:18px">Giriş Yap</h3>'+
      '<input id="__m" type="email" placeholder="kisi@sekarfilo.com.tr" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;margin:6px 0">'+
      '<input id="__p" type="password" placeholder="Şifre" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;margin:6px 0">'+
      '<input id="__n" type="text" placeholder="Kullanıcı Adı (ilk kayıt için)" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;margin:6px 0">'+
      '<button id="__l" style="width:100%;padding:10px;border:0;border-radius:8px;background:#0ea675;color:#fff">Giriş</button>'+
      '<button id="__s" style="width:100%;padding:10px;border:0;border-radius:8px;background:#334155;color:#fff;margin-top:6px">Hesap Oluştur</button>'+
      '<div id="__e" style="color:#d92d20;font-size:12px;min-height:16px;margin-top:6px"></div>'+
      '<div style="font-size:12px;color:#64748b;margin-top:4px">* Sadece @sekarfilo.com.tr kabul edilir.</div>'+
    '</div>';
    document.addEventListener('DOMContentLoaded',()=>document.body.appendChild(ov));
    function showLogin(show){ ov.style.display = show?'flex':'none'; }
    function err(t){ const el=document.getElementById('__e'); if(el) el.textContent=t||''; }

    async function createUserProfile(user, displayName){
      try{
        if (displayName) { await user.updateProfile({ displayName }); }
        await USERS.doc(user.uid).set({ uid:user.uid, email:user.email, displayName: displayName || user.displayName || "", createdAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
      }catch(e){ console.warn("profile error:", e); }
    }

    document.addEventListener('click', function(e){
      if(e.target && e.target.id==='__l'){
        const m=document.getElementById('__m').value.trim();
        const p=document.getElementById('__p').value;
        if(!/@sekarfilo\.com\.tr$/i.test(m)) return err("Sadece @sekarfilo.com.tr");
        auth.signInWithEmailAndPassword(m,p).catch(x=>err(x.message||String(x)));
      }
      if(e.target && e.target.id==='__s'){
        const m=document.getElementById('__m').value.trim();
        const p=document.getElementById('__p').value;
        const n=document.getElementById('__n').value.trim();
        if(!/@sekarfilo\.com\.tr$/i.test(m)) return err("Sadece @sekarfilo.com.tr");
        if(!n) return err("Lütfen kullanıcı adı girin");
        auth.createUserWithEmailAndPassword(m,p).then(cred => createUserProfile(cred.user, n)).catch(x=>err(x.message||String(x)));
      }
    }, true);

    function h(x){
      const s=[x.tarih,x.plaka,x.ebat,x.arac_km,x.firma,x.tur,(x.ad_soyad||''),(x.il||''),(x.ilce||''),(x.irtibat_no||''),(x.email||'')].join('|').toUpperCase();
      let a=0; for(let i=0;i<s.length;i++){ a=((a<<5)-a)+s.charCodeAt(i); a|=0; } return a.toString(36);
    }

    function subscribeOrders(){
      return ORD.orderBy("createdAt","desc").onSnapshot(snap=>{
        const rows = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        const cur  = JSON.parse(localStorage.getItem(LS_KEY)||'{}');
        const firmalar = Array.isArray(cur.firmalar)?cur.firmalar:[];
        const araclar  = Array.isArray(cur.araclar)?cur.araclar:[];
        const siparisler = rows.map(s=>({
          id:s.id,
          tarih:s.tarih || new Date().toLocaleDateString('tr-TR'),
          plaka:String(s.plaka||'').toUpperCase(),
          ebat:s.ebat||'',
          arac_km:Number.parseInt(s.arac_km||s.km||0)||0,
          firma:String(s.firma||'').toUpperCase(),
          tur:String(s.tur||'').toUpperCase(),
          ad_soyad:String(s.ad_soyad||'').toUpperCase(),
          il:String(s.il||'').toUpperCase(),
          ilce:s.ilce||'',
          irtibat_no:s.irtibat_no||'',
          email: window.emailNormalize ? window.emailNormalize(s.email||'') : (s.email||'')
        }));
        localStorage.setItem(LS_KEY, JSON.stringify({firmalar,araclar,siparisler}));
        window.dispatchEvent(new Event('orders-updated'));
      });
    }

    async function pushOrder(row){
      const user = firebase.auth().currentUser; if(!user){ showLogin(true); return; }
      const obj = { tarih:row.tarih, plaka:row.plaka, ebat:row.ebat, arac_km:Number.parseInt(row.arac_km||0)||0, firma:row.firma, tur:row.tur, ad_soyad:row.ad_soyad||'', il:row.il||'', ilce:row.ilce||'', irtibat_no:row.irtibat_no||'', email: window.emailNormalize ? window.emailNormalize(row.email||'') : (row.email||''), createdBy:user.email, createdByUid:user.uid, createdByName:user.displayName || (user.email ? user.email.split('@')[0] : ''), createdAt: firebase.firestore.FieldValue.serverTimestamp() };
      const key = h(obj); const ref = ORD.doc(key); const snap = await ref.get(); if(!snap.exists){ await ref.set({ ...obj, hash:key }, { merge:false }); }
    }
    async function deleteOrderById(id){ try{ await ORD.doc(id).delete(); }catch(e){ console.warn(e); } }
    async function updateOrderById(id, patch){
      try{
        const safe=Object.assign({},patch); if (safe.email && window.emailNormalize) safe.email = window.emailNormalize(safe.email);
        await ORD.doc(id).set({ ...safe, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
      }catch(e){ console.warn(e); throw e; }
    }

    window.pushOrder = pushOrder;
    window.deleteOrderById = deleteOrderById;
    window.updateOrderById = updateOrderById;
    window.signOut = () => firebase.auth().signOut().catch(()=>{});

    let unsub=null;
    firebase.auth().onAuthStateChanged(async user=>{
      if(user && /@sekarfilo\.com\.tr$/i.test(user.email)){
        showLogin(false);
        if (unsub) unsub();
        unsub = subscribeOrders();
        try{ await USERS.doc(user.uid).set({email:user.email, displayName:user.displayName || user.email.split('@')[0], lastLogin: firebase.firestore.FieldValue.serverTimestamp()}, {merge:true}); }catch{}
      }else{
        showLogin(true);
        if (unsub) { unsub(); unsub=null; }
      }
    });
  })();
  </script>

  <script>
    (function(){
      try{
        document.addEventListener('input', function(ev){
          var el = ev.target;
          if(!(el && el.tagName==='INPUT')) return;
          var ph = (el.getAttribute('placeholder')||'').toLowerCase();
          var name = (el.getAttribute('name')||'').toLowerCase();
          if (ph.includes('ebat') || name.includes('ebat') || ph.includes('yaz lastiği hakkı') || ph.includes('yaz lastigi hakki')) {
            var v = el.value || '';
            if (v.indexOf('@') !== -1) { el.value=''; }
          }
        }, true);
      }catch(e){}
    })();
  </script>


<!-- manual-ebat: DOM-only enhancer -->
<script>
(function(){
  function normEbat(s){
    s = String(s||'').trim().toUpperCase().replace(/\s+/g,' ');
    var m = s.match(/^(\d{3})\/(\d{2})\s*R(\d{2})$/i);
    if(!m) return null;
    return m[1] + '/' + m[2] + ' R' + m[3];
  }
  function getExtra(){
    try{ var v = localStorage.getItem('lf_extra_ebatlar'); var a = JSON.parse(v||'[]'); return Array.isArray(a)?a:[]; }catch(e){ return []; }
  }
  function saveExtra(a){
    try{ localStorage.setItem('lf_extra_ebatlar', JSON.stringify(a)); }catch(e){}
  }
  function ensureOption(sel, value){
    if(!sel) return;
    for(var i=0;i<sel.options.length;i++){
      if(String(sel.options[i].text||'').trim().toUpperCase()===value.toUpperCase()) return;
    }
    var o = document.createElement('option'); o.text = value; o.value = value; sel.appendChild(o);
  }
  function findSiparisEbatSelect(){
    // Heuristic: the select with many tire-size-looking options near the "Sipariş Ekle" button
    var btns = Array.from(document.querySelectorAll('button')).filter(b=>/sipari[sş]\s*ekle/i.test(b.textContent||''));
    if(btns.length){
      var root = btns[0].closest('form,div,section,main,article') || document.body;
      var sels = root.querySelectorAll('select');
      var reSize = /^\s*\d{3}\/\d{2}\s*R\d{2}\s*$/i;
      for(var i=0;i<sels.length;i++){
        var sel = sels[i], hits=0;
        for(var j=0;j<sel.options.length;j++){
          if(reSize.test(sel.options[j].text)) { hits++; if(hits>5) return sel; }
        }
      }
    }
    // Fallback: pick select with > 20 options matching pattern anywhere
    var all = document.querySelectorAll('select'), reSize = /^\s*\d{3}\/\d{2}\s*R\d{2}\s*$/i;
    for(var i=0;i<all.length;i++){
      var sel = all[i], hits=0;
      for(var j=0;j<sel.options.length;j++){
        if(reSize.test(all[i].options[j].text)) { hits++; if(hits>20) return sel; }
      }
    }
    return null;
  }
  function mountUI(){
    var sel = findSiparisEbatSelect();
    if(!sel){ setTimeout(mountUI, 300); return; }

    // hydrate extra sizes (+ ensure 235/50 R19 exists)
    var extras = getExtra();
    if(extras.indexOf('235/50 R19')===-1) extras.push('235/50 R19');
    extras.forEach(function(v){ ensureOption(sel, v); });

    // create UI once
    if(sel.__manualEbatMounted) return;
    sel.__manualEbatMounted = true;

    var wrap = document.createElement('div');
    wrap.style.display = 'flex'; wrap.style.alignItems='center'; wrap.style.gap='8px'; wrap.style.marginTop='8px';

    var inp = document.createElement('input');
    inp.placeholder = 'örn. 235/50 R19';
    inp.style.border='1px solid #d1d5db'; inp.style.borderRadius='6px'; inp.style.padding='6px 8px'; inp.style.fontSize='14px';

    var btn = document.createElement('button');
    btn.type = 'button'; btn.textContent = 'Ebat Ekle';
    btn.style.background='#059669'; btn.style.color='#fff'; btn.style.border='none'; btn.style.borderRadius='8px';
    btn.style.padding='6px 10px'; btn.style.cursor='pointer';

    btn.addEventListener('click', function(){
      var v = normEbat(inp.value);
      if(!v){ alert('Geçersiz ebat. Örn: 235/50 R19'); return; }
      ensureOption(sel, v);
      sel.value = v;
      var ex = getExtra(); if(ex.indexOf(v)===-1){ ex.push(v); saveExtra(ex); }
      inp.value='';
    });

    wrap.appendChild(inp); wrap.appendChild(btn);
    sel.parentNode.insertBefore(wrap, sel.nextSibling);
  }

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', mountUI);
  else mountUI();
})();
</script>

</body>
</html>
