<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SEKAR FÄ°LO LASTÄ°K HAK TAKÄ°P</title>

  <!-- âœ… Email normalizer (global, tek kaynak) â€” yalnÄ±zca domain normalize edilir -->
  <script>
  // Safe IIFE
  (function(){
    function __pcDecodeLabel(label){
      if (!label || label.slice(0,4)!=='xn--') return label;
      var base=36,tmin=1,tmax=26,damp=700,initial_bias=72;
      function digit(cp){return cp-48<10?cp-22:cp-65<26?cp-65:cp-97<26?cp-97:base;}
      function adapt(delta,numPoints,firstTime){
        delta = firstTime ? Math.floor(delta/damp) : delta>>1;
        delta += Math.floor(delta/numPoints);
        var k=0; while (delta > (((base - tmin) * tmax) >> 1)) { delta = Math.floor(delta / (base - tmin)); k += base; }
        return k + Math.floor(((base - tmin + 1) * delta) / (delta + 38));
      }
      var n=128,i=0,bias=initial_bias; var dash=label.lastIndexOf('-'); var output=[]; var idx=4;
      if (dash>4){ for(var j=4;j<dash;j++) output.push(label.charCodeAt(j)); idx=dash+1; }
      while(idx<label.length){
        var oldi=i,w=1,k=base;
        while(true){
          if(idx>=label.length) return label;
          var d=digit(label.charCodeAt(idx++));
          i+=d*w;
          var t = k<=bias ? tmin : (k>=bias+tmax ? tmax : k-bias);
          if(d<t) break;
          w*=(base-t);
        }
        var outLen=output.length+1;
        bias=adapt(i-oldi,outLen,oldi===0);
        n+=Math.floor(i/outLen);
        i%=outLen;
        output.splice(i,0,n);
        i++;
      }
      return String.fromCharCode.apply(null, output);
    }

    // Sadece domain normalize edilir; local-part korunur.
    window.emailNormalize = function(email){
      try{
        var s = String(email||'').trim();
        var at = s.indexOf('@'); if (at<0) return s;
        var local = s.slice(0,at);
        var domain = s.slice(at+1);
        var uni = domain.split('.').map(__pcDecodeLabel).join('.'); // IDNA
        try { uni = uni.toLowerCase().normalize('NFC').replace(/i\u0307/g,'i'); } catch(e){}
        return local + '@' + uni;
      }catch(e){ return String(email||'').trim(); }
    };
  })();
  </script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React + ReactDOM + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;
    const XLSX = window.XLSX;

    // TÃ¼rkiye illeri
    const TR_ILLER=["Adana","AdÄ±yaman","Afyonkarahisar","AÄŸrÄ±","Aksaray","Amasya","Ankara","Antalya","Ardahan","Artvin","AydÄ±n","BalÄ±kesir","BartÄ±n","Batman","Bayburt","Bilecik","BingÃ¶l","Bitlis","Bolu","Burdur","Bursa","Ã‡anakkale","Ã‡ankÄ±rÄ±","Ã‡orum","Denizli","DiyarbakÄ±r","DÃ¼zce","Edirne","ElazÄ±ÄŸ","Erzincan","Erzurum","EskiÅŸehir","Gaziantep","Giresun","GÃ¼mÃ¼ÅŸhane","Hakkari","Hatay","IÄŸdÄ±r","Isparta","Ä°stanbul","Ä°zmir","KahramanmaraÅŸ","KarabÃ¼k","Karaman","Kars","Kastamonu","Kayseri","KÄ±rÄ±kkale","KÄ±rklareli","KÄ±rÅŸehir","Kilis","Kocaeli","Konya","KÃ¼tahya","Malatya","Manisa","Mardin","Mersin","MuÄŸla","MuÅŸ","NevÅŸehir","NiÄŸde","Ordu","Osmaniye","Rize","Sakarya","Samsun","Siirt","Sinop","Sivas","ÅžanlÄ±urfa","ÅžÄ±rnak","TekirdaÄŸ","Tokat","Trabzon","Tunceli","UÅŸak","Van","Yalova","Yozgat","Zonguldak"];

    // ----------------- YardÄ±mcÄ±lar -----------------
    const LS_KEY  = "lastik_takip_v1";
    const FMT = /^(\d{2})\.(\d{2})\.(\d{2})$/;
    const pad2 = n => String(n).padStart(2,"0");
    const fmt  = d => `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${pad2(d.getFullYear()%100)}`;
    const today= () => fmt(new Date());

    function toDate(s){
      const m = FMT.exec(String(s ?? "")); if(!m) return null;
      const d = new Date(`${2000+ +m[3]}-${m[2]}-${m[1]}T00:00:00`);
      if(isNaN(d)) return null;
      if(d.getDate()!=+m[1]||d.getMonth()+1!=+m[2]) return null;
      return d;
    }
    const daysInc=(a,b)=>Math.floor((b-a)/86400000)+1;
    const prorata=(yk,s,e)=>{ const ds=toDate(s), de=toDate(e); if(!ds||!de||de<ds) return 0; return yk*(daysInc(ds,de)/365); };

    function normExcelDate(v){
      if(v==null) return "";
      if(typeof v==="number" && XLSX.SSF && XLSX.SSF.parse_date_code){
        const o=XLSX.SSF.parse_date_code(v);
        if(o && o.y && o.m && o.d) return fmt(new Date(o.y,o.m-1,o.d));
      }
      const s=String(v).trim();
      if(FMT.test(s)) return s;
      const m=/^(\d{4})-(\d{2})-(\d{2})$/.exec(s);
      if(m){ const d=new Date(`${m[1]}-${m[2]}-${m[3]}T00:00:00`); if(!isNaN(d)) return fmt(d); }
      const d=toDate(s); return d?fmt(d):s;
    }
    function download(name, text){
      const a=document.createElement("a");
      a.href=URL.createObjectURL(new Blob([text],{type:"text/plain;charset=utf-8"}));
      a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000);
    }
    // CSV formÃ¼l enjeksiyonu korumasÄ±
    function csvSafe(v){
      const s = String(v ?? '');
      return (/^[=+@-]/).test(s) ? "'" + s : s;
    }
    // TR normalize: 'KIÅž', 'KÄ±ÅŸ', 'kis' -> 'kis'
    function normalizeTR(s){
      try{ return String(s||'').toLowerCase().normalize('NFC').replace(/ÅŸ/g,'s').replace(/Ä±/g,'i').trim(); }catch{ return String(s||'').toLowerCase().trim(); }
    }

    // ----------------- Uygulama -----------------
    function App(){
      // LS â†’ State ilk yÃ¼kleme
      const [firmalar,setFirmalar]=useState(()=>{try{const s=localStorage.getItem(LS_KEY);return s?(JSON.parse(s).firmalar||[]):[]}catch{return[]}});      
      const [araclar,setAraclar]=useState(()=>{try{const s=localStorage.getItem(LS_KEY);return s?(JSON.parse(s).araclar||[]):[]}catch{return[]}});      
      const [siparisler,setSiparisler]=useState(()=>{try{const s=localStorage.getItem(LS_KEY);return s?(JSON.parse(s).siparisler||[]):[]}catch{return[]}});

      // ðŸ”„ LS cache gÃ¼ncelleme (yerel dÃ¼zen iÃ§in)
      useEffect(()=>{ localStorage.setItem(LS_KEY, JSON.stringify({firmalar,araclar,siparisler})) },[firmalar,araclar,siparisler]);

      // ðŸ”” Firestore snapshot tarafÄ±ndan tetiklenen global olay â†’ LS okur ve stateâ€™e basar (real-time)
      useEffect(()=>{
        function syncFromLS(){
          try{
            const cur = JSON.parse(localStorage.getItem(LS_KEY)||'{}');
            Array.isArray(cur.firmalar) && setFirmalar(cur.firmalar);
            Array.isArray(cur.araclar)  && setAraclar(cur.araclar);
            Array.isArray(cur.siparisler)&& setSiparisler(cur.siparisler);
          }catch{}
        }
        window.addEventListener('orders-updated', syncFromLS);
        return ()=>window.removeEventListener('orders-updated', syncFromLS);
      },[]);

      // SipariÅŸ formu
      const [sEbat,setSEbat]=useState(""); // placeholder ile baÅŸlar
      const [sPlaka,setSPlaka]=useState("");
      const [sAracKm,setSAracKm]=useState("");
      const [sFirma,setSFirma]=useState("");
      const [sTur,setSTur]=useState("Yaz");
      const [sAdSoyad,setSAdSoyad]=useState("");
      const [sIl,setSIl]=useState("");
      const [sIlce,setSIlce]=useState("");
      const [sIrtibat,setSIrtibat]=useState("");
      const [sEmail,setSEmail]=useState("");

      // Ã–n izleme aramasÄ± (plaka)
      const [sorguPlaka,setSorguPlaka]=useState("");

      // (gizli) ekleme formlarÄ± â€“ Excel import uyumluluÄŸu
      const [firmaId,setFirmaId]=useState("");
      const [baslangic,setBaslangic]=useState("");
      const [bitis,setBitis]=useState("");
      const [yillikKm,setYillikKm]=useState("");
      const [sinirsiz,setSinirsiz]=useState(false);

      const fileRef=useRef(null); const xlsxRef=useRef(null);

      const [userInfo,setUserInfo]=useState({email:"",name:""});

      const firmaMap = useMemo(()=> new Map(firmalar.map(f=>[f.id,f.ad])), [firmalar]);
      const seciliArac = useMemo(()=>{
        const p=(sorguPlaka||"").trim().toUpperCase();
        return araclar.find(a=>a.plaka===p)||null;
      },[sorguPlaka,araclar]);

      function siparisEkle(e){
        e.preventDefault();
        const p=(sPlaka||"").trim().toUpperCase();
        const ebat=(sEbat||"").trim();
        const kmRaw = (sAracKm||"").toString().trim();
        const km = Number.parseInt(kmRaw.replace(/\D/g,'')) || 0; // gÃ¼venli KM
        const firma=(sFirma||"").trim();
        const tur=(sTur||"Yaz");
        if(!ebat) return alert("Ebat seÃ§in");
        if(!p) return alert("Plaka girin");
        if(!firma) return alert("Firma girin");
        const id=Date.now().toString();
        const row = {
          id,
          tarih:today(),
          plaka:p.toUpperCase(),
          ebat,
          arac_km:km,
          firma:(firma||"").toUpperCase(),
          tur:(tur||"").toUpperCase(),
          ad_soyad:(sAdSoyad||"").toUpperCase(),
          il:(sIl||"").toUpperCase(),
          ilce:(sIlce||"").toUpperCase(),
          irtibat_no:sIrtibat,
          email: window.emailNormalize(sEmail),
          createdBy: userInfo.email || "",
          createdByName: userInfo.name || ""
        };
        // Yerel stateâ€™e Ã¶nden ekle (optimistic)
        setSiparisler(prev=>[row,...prev]);
        setSorguPlaka(p);
        setSEbat(""); setSPlaka(""); setSAracKm(""); setSFirma(""); setSTur("Yaz");
        setSAdSoyad(""); setSIl(""); setSIlce(""); setSIrtibat(""); setSEmail("");

        // ðŸ”Œ Firestore'a idempotent yaz (global fonksiyon)
        try{ window.pushOrder && window.pushOrder(row); }catch{}
      }
      function siparisSil(id){
        if(!confirm("Silinsin mi?")) return;
        // Optimistic local
        setSiparisler(prev=>prev.filter(s=>s.id!==id));
        // Firestoreâ€™dan da sil
        try{ window.deleteOrderById && window.deleteOrderById(id); }catch{}
      }

      // DÄ±ÅŸa ve iÃ§e aktarÄ±m
      function exportCSV(){
        const hdr=["plaka","firma_id","kira_baslangic","kira_bitis","yillik_km_hakki","notlar"];
        const rows=[hdr.join(",")];
        for(const a of araclar){
          const line = [
            csvSafe(a.plaka),
            csvSafe(a.firma_id),
            csvSafe(a.kira_baslangic),
            csvSafe(a.kira_bitis),
            csvSafe(a.yillik_km_hakki==null?"":a.yillik_km_hakki),
            csvSafe((a.notlar||"").replaceAll(",",";"))
          ].join(",");
          rows.push(line);
        }
        download("araclar.csv",rows.join("\n"));
      }
      function exportJSON(){ download("veri.json", JSON.stringify({firmalar,araclar,siparisler},null,2)); }
      function importJSON(ev){
        const f=ev.target.files?.[0]; if(!f) return;
        const fr=new FileReader(); fr.onload=()=>{ try{
          const d=JSON.parse(String(fr.result||"{}"));
          if(Array.isArray(d.firmalar)) setFirmalar(d.firmalar);
          if(Array.isArray(d.araclar)) setAraclar(d.araclar);
          if(Array.isArray(d.siparisler)) setSiparisler(d.siparisler);
        }catch(e){ alert("JSON okunamadÄ±: "+e.message) } finally{ ev.target.value=""; } }; fr.readAsText(f,"utf-8");
      }
      function importXLSX(ev){
        const f=ev.target.files?.[0]; if(!f) return;
        const fr=new FileReader(); fr.onload=()=>{ try{
          const wb=XLSX.read(new Uint8Array(fr.result),{type:"array"});
          const wsF=wb.Sheets["Firmalar"]||wb.Sheets["firmalar"]; let yeniF=[];
          if(wsF){ yeniF=XLSX.utils.sheet_to_json(wsF,{defval:""}).map(r=>({id:String(r.id||"").trim(), ad:String(r.ad||"").trim()})).filter(x=>x.id&&x.ad); }
          const wsA=wb.Sheets["Araclar"]||wb.Sheets["araclar"]; let yeniA=[];
          if(wsA){
            yeniA=XLSX.utils.sheet_to_json(wsA,{defval:""}).map(r=>{
              const yk=String(r.yillik_km_hakki??"").trim();
              const ykVal = yk==="" ? null : (Number.isFinite(Number(yk))?Math.floor(Number(yk)):null);
              return {plaka:String(r.plaka||"").trim().toUpperCase(),
                      firma_id:String(r.firma_id||"").trim(),
                      kira_baslangic:normExcelDate(r.kira_baslangic),
                      kira_bitis:normExcelDate(r.kira_bitis),
                      yillik_km_hakki: ykVal,
                      notlar:String(r.notlar||"").trim()};
            }).filter(a=>a.plaka&&a.firma_id&&a.kira_baslangic&&a.kira_bitis);
          }
          if(yeniF.length){ const m=new Map(firmalar.map(f=>[f.id,f])); yeniF.forEach(f=>m.set(f.id,f)); setFirmalar([...m.values()].sort((a,b)=>a.id.localeCompare(b.id))); }
          if(yeniA.length){ const m=new Map(araclar.map(a=>[a.plaka,a])); yeniA.forEach(a=>m.set(a.plaka,a)); setAraclar([...m.values()].sort((a,b)=>a.plaka.localeCompare(b.plaka))); }
          if(!yeniF.length && !yeniA.length) alert("Excel'de 'Firmalar' ve/veya 'Araclar' sayfalarÄ± yok.");
        }catch(e){ alert("Excel okunamadÄ±: "+e.message) } finally{ ev.target.value=""; } }; fr.readAsArrayBuffer(f);
      }

      // SipariÅŸ filtreleri
      const [sfBas,setSfBas]=useState(""),[sfBit,setSfBit]=useState(""),[sfPlaka,setSfPlaka]=useState(""),
            [sfFirma,setSfFirma]=useState(""),[sfTur,setSfTur]=useState(""),[sfEbat,setSfEbat]=useState("");

      const filtered = useMemo(()=>{
        const s=toDate(sfBas), e=toDate(sfBit);
        const N=x=>String(x||"").toUpperCase();
        const fPl=N(sfPlaka), fFi=N(sfFirma), fEb=N(sfEbat), fT=N(sfTur);
        return siparisler.filter(x=>{
          const d=toDate(x.tarih); if(!d) return false;
          if(s&&d<s) return false; if(e&&d>e) return false;
          if(fPl && !N(x.plaka).includes(fPl)) return false;
          if(fFi && !N(x.firma||"").includes(fFi)) return false;
          if(fT && N(x.tur)!==fT) return false;
          if(fEb && !N(x.ebat).includes(fEb)) return false;
          return true;
        });
      },[siparisler,sfBas,sfBit,sfPlaka,sfFirma,sfTur,sfEbat]);

      function exportSiparisExcel(){
        const rows = filtered.map(s=>({
          Tarih:s.tarih,
          Plaka:s.plaka,
          Ebat:s.ebat,
          "AraÃ§ KM": Number.parseInt(s.arac_km||0)||0,
          Firma:(s.firma||""),
          TÃ¼r:s.tur,
          "Ä°sim Soyisim":(s.ad_soyad||""),
          "Ä°l":(s.il||""),
          "Ä°lÃ§e":(s.ilce||""),
          "Ä°rtibat":(s.irtibat_no||""),
          "E-posta": window.emailNormalize(s.email||"")
        }));
        if(!rows.length) return alert("Filtreye uyan sipariÅŸ yok.");
        const ws=XLSX.utils.json_to_sheet(rows), wb=XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb,ws,"Siparisler"); XLSX.writeFile(wb,"siparisler.xlsx");
      }

      const siparisOzet = useMemo(()=>{
        const p=(sorguPlaka||"").trim().toUpperCase(); let yaz=0,kis=0;
        if(!p) return {yaz,kis};
        for(const s of siparisler){
          if(String(s.plaka).toUpperCase()===p){
            normalizeTR(s.tur||'Yaz')==='kis' ? kis++ : yaz++;
          }
        }
        return {yaz,kis};
      },[sorguPlaka,siparisler]);

      // --------------- UI ---------------
      return (
        <div className="min-h-screen">
          <header className="sticky top-0 z-10 bg-emerald-600 text-white">
            <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
              <h1 className="text-2xl font-bold">SEKAR FÄ°LO LASTÄ°K HAK TAKÄ°P</h1>
              <div className="flex items-center gap-3">
                {userInfo.email && (
                  <div className="text-xs bg-white/15 px-3 py-1.5 rounded-xl">{userInfo.name||userInfo.email}</div>
                )}
                <div className="flex gap-2">
                  <button onClick={exportCSV} className="px-3 py-1.5 rounded-xl border border-white text-white/90 hover:bg-white/10">CSV</button>
                  <button onClick={exportJSON} className="px-3 py-1.5 rounded-xl border border-white text-white/90 hover:bg-white/10">JSON</button>
                  <input ref={fileRef} type="file" accept="application/json" onChange={importJSON} className="hidden"/>
                  <button onClick={()=>fileRef.current?.click()} className="px-3 py-1.5 rounded-xl border border-white text-white/90 hover:bg-white/10">JSON Ä°Ã§e Al</button>
                  <input ref={xlsxRef} type="file" accept=".xlsx,.xls" onChange={importXLSX} className="hidden"/>
                  <button onClick={()=>xlsxRef.current?.click()} className="px-3 py-1.5 rounded-xl border border-white text-white/90 hover:bg-white/10">Excel Ä°Ã§e Al</button>
                  <button onClick={()=>window.signOut && window.signOut()} className="px-3 py-1.5 rounded-xl border border-white text-white/90 hover:bg-white/10">Ã‡Ä±kÄ±ÅŸ</button>
                </div>
              </div>
            </div>
          </header>

          <main className="max-w-7xl mx-auto p-4 grid grid-cols-1 gap-4">
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 items-stretch">
              {/* Lastik SipariÅŸi */}
              <div className="bg-white rounded-2xl p-4 shadow h-full">
                <h2 className="text-lg font-semibold mb-3">Lastik SipariÅŸi</h2>
                <form onSubmit={siparisEkle} className="space-y-3">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-2">

                    <div>
                      <label className="block text-xs font-medium text-gray-600 mb-0.5">Lastik EbatÄ±</label>
                      <select value={sEbat} onChange={e=>setSEbat(e.target.value)} className="mt-1 w-full rounded-lg border px-2 py-1 text-sm">
                        <option value="">â€” SeÃ§in â€”</option>
                        <option value="135/80 R13">135/80 R13</option>
                        <option value="145/70 R13">145/70 R13</option>
                        <option value="145/80 R13">145/80 R13</option>
                        <option value="155/65 R13">155/65 R13</option>
                        <option value="155/70 R13">155/70 R13</option>
                        <option value="155/80 R13">155/80 R13</option>
                        <option value="165/60 R13">165/60 R13</option>
                        <option value="165/65 R13">165/65 R13</option>
                        <option value="165/70 R13">165/70 R13</option>
                        <option value="175/60 R13">175/60 R13</option>
                        <option value="175/65 R13">175/65 R13</option>
                        <option value="175/70 R13">175/70 R13</option>
                        <option value="165/60 R14">165/60 R14</option>
                        <option value="165/65 R14">165/65 R14</option>
                        <option value="165/70 R14">165/70 R14</option>
                        <option value="175/60 R14">175/60 R14</option>
                        <option value="175/65 R14">175/65 R14</option>
                        <option value="175/70 R14">175/70 R14</option>
                        <option value="185/55 R14">185/55 R14</option>
                        <option value="185/60 R14">185/60 R14</option>
                        <option value="185/65 R14">185/65 R14</option>
                        <option value="185/70 R14">185/70 R14</option>
                        <option value="195/60 R14">195/60 R14</option>
                        <option value="195/65 R14">195/65 R14</option>
                        <option value="175/65 R15">175/65 R15</option>
                        <option value="185/55 R15">185/55 R15</option>
                        <option value="185/60 R15">185/60 R15</option>
                        <option value="185/65 R15">185/65 R15</option>
                        <option value="195/50 R15">195/50 R15</option>
                        <option value="195/55 R15">195/55 R15</option>
                        <option value="195/60 R15">195/60 R15</option>
                        <option value="195/65 R15">195/65 R15</option>
                        <option value="205/50 R15">205/50 R15</option>
                        <option value="205/55 R15">205/55 R15</option>
                        <option value="205/60 R15">205/60 R15</option>
                        <option value="205/65 R15">205/65 R15</option>
                        <option value="195/45 R16">195/45 R16</option>
                        <option value="195/50 R16">195/50 R16</option>
                        <option value="195/55 R16">195/55 R16</option>
                        <option value="205/45 R16">205/45 R16</option>
                        <option value="205/50 R16">205/50 R16</option>
                        <option value="205/55 R16">205/55 R16</option>
                        <option value="205/60 R16">205/60 R16</option>
                        <option value="205/65 R16">205/65 R16</option>
                        <option value="215/55 R16">215/55 R16</option>
                        <option value="215/60 R16">215/60 R16</option>
                        <option value="215/65 R16">215/65 R16</option>
                        <option value="225/50 R16">225/50 R16</option>
                        <option value="225/55 R16">225/55 R16</option>
                        <option value="205/45 R17">205/45 R17</option>
                        <option value="205/50 R17">205/50 R17</option>
                        <option value="205/55 R17">205/55 R17</option>
                        <option value="215/45 R17">215/45 R17</option>
                        <option value="215/50 R17">215/50 R17</option>
                        <option value="215/55 R17">215/55 R17</option>
                        <option value="215/60 R17">215/60 R17</option>
                        <option value="225/45 R17">225/45 R17</option>
                        <option value="225/50 R17">225/50 R17</option>
                        <option value="225/55 R17">225/55 R17</option>
                        <option value="235/45 R17">235/45 R17</option>
                        <option value="235/55 R17">235/55 R17</option>
                        <option value="215/40 R18">215/40 R18</option>
                        <option value="215/45 R18">215/45 R18</option>
                        <option value="225/40 R18">225/40 R18</option>
                        <option value="225/45 R18">225/45 R18</option>
                        <option value="235/40 R18">235/40 R18</option>
                        <option value="235/45 R18">235/45 R18</option>
                        <option value="235/50 R18">235/50 R18</option>
                        <option value="235/55 R18">235/55 R18</option>
                        <option value="245/40 R18">245/40 R18</option>
                        <option value="245/45 R18">245/45 R18</option>
                        <option value="255/45 R18">255/45 R18</option>
                        <option value="225/35 R19">225/35 R19</option>
                        <option value="225/40 R19">225/40 R19</option>
                        <option value="235/35 R19">235/35 R19</option>
                        <option value="235/40 R19">235/40 R19</option>
                        <option value="235/45 R19">235/45 R19</option>
                        <option value="245/40 R19">245/40 R19</option>
                        <option value="255/35 R19">255/35 R19</option>
                        <option value="255/40 R19">255/40 R19</option>
                        <option value="255/45 R19">255/45 R19</option>
                        <option value="275/35 R19">275/35 R19</option>
                        <option value="235/35 R20">235/35 R20</option>
                        <option value="245/35 R20">245/35 R20</option>
                        <option value="245/40 R20">245/40 R20</option>
                        <option value="255/35 R20">255/35 R20</option>
                        <option value="255/40 R20">255/40 R20</option>
                        <option value="265/40 R20">265/40 R20</option>
                        <option value="275/35 R20">275/35 R20</option>
                        <option value="275/40 R20">275/40 R20</option>
                        <option value="245/35 R21">245/35 R21</option>
                        <option value="255/35 R21">255/35 R21</option>
                        <option value="265/40 R21">265/40 R21</option>
                        <option value="275/35 R21">275/35 R21</option>
                        <option value="285/35 R21">285/35 R21</option>
                        <option value="275/35 R22">275/35 R22</option>
                        <option value="285/35 R22">285/35 R22</option>
                        <option value="295/35 R22">295/35 R22</option>
                        <option value="185/75 R16C">185/75 R16C</option>
                        <option value="195/65 R16C">195/65 R16C</option>
                        <option value="195/70 R15C">195/70 R15C</option>
                        <option value="195/75 R16C">195/75 R16C</option>
                        <option value="205/65 R16C">205/65 R16C</option>
                        <option value="205/70 R15C">205/70 R15C</option>
                        <option value="205/75 R16C">205/75 R16C</option>
                        <option value="215/65 R16C">215/65 R16C</option>
                        <option value="225/65 R16C">225/65 R16C</option>
                        <option value="215/60 R17">215/60 R17</option>
                        <option value="225/60 R17">225/60 R17</option>
                        <option value="235/60 R17">235/60 R17</option>
                        <option value="225/65 R17">225/65 R17</option>
                        <option value="235/65 R17">235/65 R17</option>
                        <option value="245/65 R17">245/65 R17</option>
                        <option value="235/55 R18">235/55 R18</option>
                        <option value="235/60 R18">235/60 R18</option>
                        <option value="255/55 R18">255/55 R18</option>
                        <option value="235/55 R19">235/55 R19</option>
                        <option value="255/50 R19">255/50 R19</option>
                        <option value="255/45 R20">255/45 R20</option>
                      </select>
                    </div>

                    <div><label className="block text-xs font-medium text-gray-600">Plaka</label>
                      <input value={sPlaka} onChange={e=>setSPlaka(e.target.value.toUpperCase())} placeholder="34ABC123" className="mt-1 w-full rounded-lg border px-2 py-1 uppercase tracking-wide"/></div>
                    <div><label className="block text-xs font-medium text-gray-600">AraÃ§ KM</label>
                      <input value={sAracKm} onChange={e=>setSAracKm(e.target.value)} placeholder="Ã–rn: 120000" className="mt-1 w-full rounded-lg border px-2 py-1 text-sm"/></div>
                    <div><label className="block text-xs font-medium text-gray-600">Lastik FirmasÄ±</label>
                      <input value={sFirma} onChange={e=>setSFirma(e.target.value)} placeholder="Ã–rn: LastikCo" className="mt-1 w-full rounded-lg border px-2 py-1 text-sm"/></div>
                    <div><label className="block text-xs font-medium text-gray-600">TÃ¼r</label>
                      <select value={sTur} onChange={e=>setSTur(e.target.value)} className="mt-1 w-full rounded-lg border px-2 py-1 text-sm"><option>Yaz</option><option>KÄ±ÅŸ</option></select></div>

                    <div><label className="block text-xs font-medium text-gray-600">Ä°sim Soyisim</label>
                      <input value={sAdSoyad} onChange={e=>setSAdSoyad(e.target.value)} placeholder="Ã–rn: Ali Veli" className="mt-1 w-full rounded-lg border px-2 py-1 text-sm"/></div>
                    <div><label className="block text-xs font-medium text-gray-600">Ä°l</label>
                      <select value={sIl} onChange={e=>setSIl(e.target.value)} className="mt-1 w-full rounded-lg border px-2 py-1 text-sm">
                        <option value="">Ä°l (SeÃ§in)</option>
                        {TR_ILLER.map((il,i)=>(<option key={i} value={il}>{il}</option>))}
                      </select></div>
                    <div><label className="block text-xs font-medium text-gray-600">Ä°lÃ§e</label>
                      <input value={sIlce} onChange={e=>setSIlce(e.target.value)} placeholder="Ä°lÃ§e" className="mt-1 w-full rounded-lg border px-2 py-1 text-sm"/></div>
                    <div><label className="block text-xs font-medium text-gray-600">Ä°rtibat No</label>
                      <input value={sIrtibat} onChange={e=>setSIrtibat(e.target.value)} placeholder="Ã–rn: 5xx xxx xx xx" className="mt-1 w-full rounded-lg border px-2 py-1 text-sm"/></div>
                    <div><label className="block text-xs font-medium text-gray-600">E-posta</label>
                      <input type="email" value={sEmail} onChange={e=>setSEmail(e.target.value)} placeholder="ornek@mail.com" className="mt-1 w-full rounded-lg border px-2 py-1 text-sm"/></div>

                  </div>
                  <div className="mt-2 md:col-span-2">
                    <button className="w-full py-2 text-sm rounded-lg bg-emerald-600 text-white hover:opacity-95">SipariÅŸ Ekle</button>
                  </div>
                </form>
              </div>

              {/* CanlÄ± Ã–nizleme */}
              <div className="bg-white rounded-2xl p-4 shadow h-full">
                <h2 className="text-lg font-semibold mb-3">CanlÄ± Ã–nizleme</h2>
                <PreviewCard
                  temp={{
                    plaka:(sorguPlaka||"").toUpperCase(),
                    firma_ad: seciliArac ? (firmaMap.get(seciliArac.firma_id)||seciliArac.firma_id) : (firmaMap.get(firmaId)||firmaId||"â€”"),
                    kira_baslangic: seciliArac ? seciliArac.kira_baslangic : (baslangic || "â€”"),
                    kira_bitis: seciliArac ? seciliArac.kira_bitis : (bitis || "â€”"),
                    yillik_km: seciliArac ? (seciliArac.yillik_km_hakki===null?null:seciliArac.yillik_km_hakki) : (sinirsiz?null:(Number.parseInt(yillikKm)||0)),
                    tahmini_km: (()=>{ const s=seciliArac?seciliArac.kira_baslangic:baslangic, e=seciliArac?seciliArac.kira_bitis:bitis, y=seciliArac?seciliArac.yillik_km_hakki:(sinirsiz?null:(Number.parseInt(yillikKm)||0)); return y===null?200000:Math.round(prorata(y,s||"",e||"")); })(),
                    kis_hakki: (seciliArac?1:(baslangic&&bitis?1:0)),
                    yaz_hakki: (()=>{ const s=seciliArac?seciliArac.kira_baslangic:baslangic, e=seciliArac?seciliArac.kira_bitis:bitis, y=seciliArac?seciliArac.yillik_km_hakki:(sinirsiz?null:(Number.parseInt(yillikKm)||0)); const t=(y===null)?200000:Math.round(prorata(y,s||"",e||"")); return Math.floor(Math.max(0,t)/50000); })(),
                  }}
                  queryPlaka={sorguPlaka}
                  onQueryChange={setSorguPlaka}
                  orderCounts={siparisOzet}
                />
              </div>
            </div>

            {/* SipariÅŸ Listesi */}
            <div className="bg-white rounded-2xl p-3 shadow">
              <div className="flex items-center justify-between mb-3 gap-2 flex-wrap">
                <h2 className="text-lg font-semibold">SipariÅŸler</h2>
                <div className="flex items-end gap-2 flex-wrap">
                  <div><label className="block text-xs text-gray-500">BaÅŸlangÄ±Ã§</label>
                    <input value={sfBas} onChange={e=>setSfBas(e.target.value)} placeholder="01.01.25" className="border rounded-xl px-3 py-1.5"/></div>
                  <div><label className="block text-xs text-gray-500">BitiÅŸ</label>
                    <input value={sfBit} onChange={e=>setSfBit(e.target.value)} placeholder="31.12.25" className="border rounded-xl px-3 py-1.5"/></div>
                  <div><label className="block text-xs text-gray-500">Plaka</label>
                    <input value={sfPlaka} onChange={e=>setSfPlaka(e.target.value)} placeholder="34ABC123" className="border rounded-xl px-3 py-1.5 uppercase"/></div>
                  <div><label className="block text-xs text-gray-500">Lastik FirmasÄ±</label>
                    <input value={sfFirma} onChange={e=>setSfFirma(e.target.value)} placeholder="Firma araâ€¦" className="border rounded-xl px-3 py-1.5"/></div>
                  <div><label className="block text-xs text-gray-500">TÃ¼r</label>
                    <select value={sfTur} onChange={e=>setSfTur(e.target.value)} className="border rounded-xl px-3 py-1.5"><option value="">Hepsi</option><option value="Yaz">Yaz</option><option value="KÄ±ÅŸ">KÄ±ÅŸ</option></select></div>
                  <div><label className="block text-xs text-gray-500">Ebat</label>
                    <input value={sfEbat} onChange={e=>setSfEbat(e.target.value)} placeholder="205/55 R16" className="border rounded-xl px-3 py-1.5"/></div>
                  <button onClick={()=>{setSfBas("");setSfBit("");setSfPlaka("");setSfFirma("");setSfTur("");setSfEbat("");}} className="px-3 py-1.5 rounded-xl border shadow-sm">Filtreyi Temizle</button>
                  <button onClick={exportSiparisExcel} className="px-3 py-1.5 rounded-xl border shadow-sm">Excel'e Aktar</button>
                </div>
              </div>
              {filtered.length===0 ? <p className="text-sm text-gray-600">HenÃ¼z sipariÅŸ yok.</p> :
                <div className="overflow-auto">
                  <table className="min-w-full text-sm">
                    <thead><tr className="text-left border-b">
                      <th className="py-2 pr-4">Tarih</th><th className="py-2 pr-4">Plaka</th><th className="py-2 pr-4">Ebat</th>
                      <th className="py-2 pr-4">AraÃ§ KM</th><th className="py-2 pr-4">Firma</th><th className="py-2 pr-4">TÃ¼r</th><th className="py-2 pr-4">Ä°sim Soyisim</th><th className="py-2 pr-4">Ä°l</th><th className="py-2 pr-4">Ä°lÃ§e</th><th className="py-2 pr-4">Ä°rtibat</th><th className="py-2 pr-4">E-posta</th><th className="py-2 pr-4">Ä°ÅŸlem</th>
                    </tr></thead>
                    <tbody>
                      {filtered.map(s=>(
                        <tr key={s.id} className="border-b last:border-0">
                          <td className="py-2 pr-4 whitespace-nowrap">{s.tarih}</td>
                          <td className="py-2 pr-4 whitespace-nowrap"><button className="underline" onClick={()=>setSorguPlaka(s.plaka)}>{s.plaka}</button></td>
                          <td className="py-2 pr-4 whitespace-nowrap">{s.ebat}</td>
                          <td className="py-2 pr-4 whitespace-nowrap">{(Number.parseInt(s.arac_km||0)||0).toLocaleString("tr-TR")}</td>
                          <td className="py-2 pr-4 whitespace-nowrap">{s.firma||""}</td>
                          <td className="py-2 pr-4 whitespace-nowrap">{s.tur}</td>
                          <td className="py-2 pr-4 whitespace-nowrap">{s.ad_soyad||""}</td>
                          <td className="py-2 pr-4 whitespace-nowrap">{s.il||""}</td>
                          <td className="py-2 pr-4 whitespace-nowrap">{s.ilce||""}</td>
                          <td className="py-2 pr-4 whitespace-nowrap">{s.irtibat_no||""}</td>
                          <td className="py-2 pr-4 whitespace-nowrap">{window.emailNormalize(s.email||"")}</td>
                          <td className="py-2 pr-4"><button onClick={()=>siparisSil(s.id)} className="px-2 py-1 rounded-lg border hover:shadow">Sil</button></td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>}
            </div>
          </main>

          <footer className="max-w-7xl mx-auto px-4 py-6 text-xs text-gray-500">
            <p>KÄ±ÅŸ lastiÄŸi 1 defa; Yaz lastiÄŸi her 50.000 km dolumda 1 hak. SÄ±nÄ±rsÄ±z durumda tahmini dÃ¶nem KM=200.000.</p>
          </footer>
        </div>
      );
    }

    function PreviewCard({temp, queryPlaka, onQueryChange, orderCounts}){
      const valid = temp.kira_baslangic!=="â€”" && temp.kira_bitis!=="â€”" && temp.plaka;
      return (
        <div className="rounded-2xl border p-4 grid md:grid-cols-2 gap-4">
          <div>
            <div className="text-sm text-gray-500 mb-1">Ã–nizleme</div>
            <input value={queryPlaka} onChange={e=>onQueryChange(e.target.value.toUpperCase())}
                   placeholder="PLAKA YAZIN (Ã¶rn: 34ABC123)"
                   className="w-full bg-transparent outline-none font-semibold text-xl uppercase tracking-wide border-b border-dashed focus:border-gray-400"/>
            <div className="text-sm mt-1">{temp.firma_ad}</div>
            <div className="mt-3 grid grid-cols-2 gap-3 text-sm">
              <div><div className="text-gray-500">BaÅŸlangÄ±Ã§</div><div className="font-medium">{temp.kira_baslangic}</div></div>
              <div><div className="text-gray-500">BitiÅŸ</div><div className="font-medium">{temp.kira_bitis}</div></div>
              <div><div className="text-gray-500">YÄ±llÄ±k KM</div><div className="font-medium">{temp.yillik_km==null?"SÄ±nÄ±rsÄ±z":Number(temp.yillik_km).toLocaleString("tr-TR")}</div></div>
              <div><div className="text-gray-500">Tahmini DÃ¶nem KM</div><div className="font-medium">{Number(temp.tahmini_km||0).toLocaleString("tr-TR")}</div></div>
              <div><div className="text-gray-500">KÄ±ÅŸ LastiÄŸi HakkÄ±</div><div className="font-medium">{valid?temp.kis_hakki:0}</div></div>
              <div><div className="text-gray-500">Yaz LastiÄŸi HakkÄ±</div><div className="font-medium">{valid?temp.yaz_hakki:0}</div></div>
            </div>
          </div>
          <div className="self-center">
            <div className="mt-0 p-3 bg-amber-50 rounded-xl border border-amber-200 text-sm">
              <div className="font-semibold mb-1">Bu plaka iÃ§in verilen sipariÅŸler</div>
              <div className="flex gap-6">
                <div>KÄ±ÅŸ: <span className="font-semibold">{orderCounts.kis}</span></div>
                <div>Yaz: <span className="font-semibold">{orderCounts.yaz}</span></div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>

  <!-- ðŸ”Œ Firebase compat kÃ¼tÃ¼phaneleri -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
// Tek kaynak: Firestore (real-time). LocalStorage sadece cache.
// TÃ¼m oturum aÃ§mÄ±ÅŸ @sekarfilo.com.tr kullanÄ±cÄ±larÄ± aynÄ± veriyi anlÄ±k gÃ¶rÃ¼r.

(function(){
  const LS_KEY = "lastik_takip_v1";
  const COLL   = "lastik_siparisleri";
  const firebaseConfig = {
    apiKey: "AIzaSyB-xEmeTVN8oiB4FZzV4UpJpAHkyDHYF4U",
    authDomain: "sekar-filo.firebaseapp.com",
    projectId: "sekar-filo",
    storageBucket: "sekar-filo.appspot.com",
    messagingSenderId: "61274893830",
    appId: "1:61274893830:web:c9dfdf8baf0500178f9d87"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();
  const ORD  = db.collection(COLL);
  const USERS = db.collection("users");

  // Basit giriÅŸ kutusu (yalnÄ±zca @sekarfilo.com.tr)
  const ov = document.createElement('div');
  ov.style.cssText="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.08);backdrop-filter:blur(2px);z-index:99999";
  ov.innerHTML = '<div style="background:#fff;padding:18px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.2);width:340px;font-family:system-ui">'+
    '<h3 style="margin:0 0 8px;font-size:18px">GiriÅŸ Yap</h3>'+
    '<input id="__m" type="email" placeholder="kisi@sekarfilo.com.tr" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;margin:6px 0">'+
    '<input id="__p" type="password" placeholder="Åžifre" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;margin:6px 0">'+
    '<input id="__n" type="text" placeholder="KullanÄ±cÄ± AdÄ± (ilk kayÄ±t iÃ§in)" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;margin:6px 0">'+
    '<button id="__l" style="width:100%;padding:10px;border:0;border-radius:8px;background:#0ea675;color:#fff">GiriÅŸ</button>'+
    '<button id="__s" style="width:100%;padding:10px;border:0;border-radius:8px;background:#334155;color:#fff;margin-top:6px">Hesap OluÅŸtur</button>'+
    '<div id="__e" style="color:#d92d20;font-size:12px;min-height:16px;margin-top:6px"></div>'+
    '<div style="font-size:12px;color:#64748b;margin-top:4px">* Sadece @sekarfilo.com.tr kabul edilir.</div>'+
  '</div>';
  document.addEventListener('DOMContentLoaded',()=>document.body.appendChild(ov));

  function showLogin(show){ ov.style.display = show?'flex':'none'; }
  function err(t){ const el=document.getElementById('__e'); if(el) el.textContent=t||''; }

  async function createUserProfile(user, displayName){
    try{
      if (displayName) { await user.updateProfile({ displayName }); }
      await USERS.doc(user.uid).set({
        uid: user.uid,
        email: user.email,
        displayName: displayName || user.displayName || "",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    }catch(e){
      console.warn("profile error:", e);
    }
  }

  document.addEventListener('click', function(e){
    if(e.target && e.target.id==='__l'){
      const m=document.getElementById('__m').value.trim();
      const p=document.getElementById('__p').value;
      if(!/@sekarfilo\.com\.tr$/i.test(m)) return err("Sadece @sekarfilo.com.tr");
      auth.signInWithEmailAndPassword(m,p).catch(x=>err(x.message||String(x)));
    }
    if(e.target && e.target.id==='__s'){
      const m=document.getElementById('__m').value.trim();
      const p=document.getElementById('__p').value;
      const n=document.getElementById('__n').value.trim();
      if(!/@sekarfilo\.com\.tr$/i.test(m)) return err("Sadece @sekarfilo.com.tr");
      if(!n) return err("LÃ¼tfen kullanÄ±cÄ± adÄ± girin");
      auth.createUserWithEmailAndPassword(m,p)
        .then(cred => createUserProfile(cred.user, n))
        .catch(x=>err(x.message||String(x)));
    }
  }, true);

  // Hash (doc id olarak da kullanacaÄŸÄ±z)
  function h(x){
    const s=[x.tarih,x.plaka,x.ebat,x.arac_km,x.firma,x.tur,(x.ad_soyad||''),(x.il||''),(x.ilce||''),(x.irtibat_no||''),(x.email||'')].join('|').toUpperCase();
    let a=0; for(let i=0;i<s.length;i++){ a=((a<<5)-a)+s.charCodeAt(i); a|=0; } return a.toString(36);
  }

  // Real-time dinleyici: tÃ¼m kullanÄ±cÄ±lara aynÄ± listeyi anÄ±nda verir
  function subscribeOrders(setHeaderUser){
    return ORD.orderBy("createdAt","desc").onSnapshot(snap=>{
      const rows = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      const cur  = JSON.parse(localStorage.getItem(LS_KEY)||'{}');
      const firmalar = Array.isArray(cur.firmalar)?cur.firmalar:[];
      const araclar  = Array.isArray(cur.araclar)?cur.araclar:[];
      const siparisler = rows.map(s=>({
        id: s.id,
        tarih: s.tarih || new Date().toLocaleDateString('tr-TR'),
        plaka: String(s.plaka||'').toUpperCase(),
        ebat: s.ebat||'',
        arac_km: Number.parseInt(s.arac_km||s.km||0) || 0,
        firma: String(s.firma||'').toUpperCase(),
        tur: String(s.tur||'').toUpperCase(),
        ad_soyad: String(s.ad_soyad||'').toUpperCase(),
        il: String(s.il||'').toUpperCase(),
        ilce: s.ilce||'',
        irtibat_no: s.irtibat_no||'',
        email: window.emailNormalize ? window.emailNormalize(s.email||'') : (s.email||'')
      }));
      localStorage.setItem(LS_KEY, JSON.stringify({firmalar,araclar,siparisler}));
      // React uygulamasÄ±na bildir (App dinliyor)
      window.dispatchEvent(new Event('orders-updated'));
    });
  }

  // Idempotent yazma: doc(hash) â†’ aynÄ± kayÄ±t iki kez yazÄ±lmaz
  async function pushOrder(row){
    const user = auth.currentUser;
    if(!user){ showLogin(true); return; }
    const obj = {
      tarih: row.tarih,
      plaka: row.plaka,
      ebat: row.ebat,
      arac_km: Number.parseInt(row.arac_km||0)||0,
      firma: row.firma,
      tur: row.tur,
      ad_soyad: row.ad_soyad||'',
      il: row.il||'',
      ilce: row.ilce||'',
      irtibat_no: row.irtibat_no||'',
      email: window.emailNormalize ? window.emailNormalize(row.email||'') : (row.email||''),
      createdBy: user.email,
      createdByUid: user.uid,
      createdByName: user.displayName || (user.email ? user.email.split('@')[0] : ''),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    const key = h(obj);
    const ref = ORD.doc(key);
    const snap = await ref.get();
    if(!snap.exists){
      await ref.set({ ...obj, hash: key }, { merge: false });
    }
  }

  // Silme
  async function deleteOrderById(id){
    try{
      await ORD.doc(id).delete();
    }catch(e){ console.warn(e); }
  }

  // Global export (App Ã§aÄŸÄ±racak)
  window.pushOrder = pushOrder;
  window.deleteOrderById = deleteOrderById;
  window.signOut = () => auth.signOut().catch(()=>{});

  // Auth state
  let unsub = null;
  auth.onAuthStateChanged(async user=>{
    if(user && /@sekarfilo\.com\.tr$/i.test(user.email)){
      showLogin(false);
      // kullanÄ±cÄ± bilgilerini header'a yazmak iÃ§in bir CustomEvent gÃ¶nder
      const info = {email:user.email, name: user.displayName || user.email.split('@')[0]};
      window.dispatchEvent(new CustomEvent('header-user', { detail: info }));
      if (unsub) unsub();
      unsub = subscribeOrders();
      // kullanÄ±cÄ± belgesini de gÃ¼ncel tut
      try{ await USERS.doc(user.uid).set({email:user.email, displayName:info.name, lastLogin: firebase.firestore.FieldValue.serverTimestamp()}, {merge:true}); }catch{}
    }else{
      showLogin(true);
      window.dispatchEvent(new CustomEvent('header-user', { detail: {email:"", name:""} }));
      if (unsub) { unsub(); unsub=null; }
    }
  });

  // React tarafÄ±nda header'da gÃ¶stermek iÃ§in
  window.addEventListener('header-user', (e)=>{
    try{
      const detail = e.detail || {};
      // App iÃ§indeki state'i gÃ¼ncellemek iÃ§in global deÄŸiÅŸken yerine LS sinyali yapÄ±yoruz
      const cur = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
      cur.__user = detail;
      localStorage.setItem(LS_KEY, JSON.stringify(cur));
      window.dispatchEvent(new Event('orders-updated'));
    }catch{}
  });

})();
  </script>
</body>
</html>
