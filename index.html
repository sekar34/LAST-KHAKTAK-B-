<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SEKAR FİLO LASTİK HAK TAKİP</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS (Excel'e aktar) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body{background:#f5f7f6}
    .card{background:#fff;border-radius:16px;box-shadow:0 4px 18px rgba(0,0,0,.05)}
    .btn{background:#0f8a5f;color:#fff;border-radius:10px;padding:.6rem 1rem}
    .btn:hover{filter:brightness(.95)}
    .btn-outline{border:1px solid #e5e7eb;border-radius:10px;padding:.5rem .9rem}
    .input{border:1px solid #e5e7eb;border-radius:10px;padding:.45rem .6rem}
    th{background:#0f8a5f;color:#fff;font-weight:600}
  </style>

  <!-- Email normalizer: büyük/küçük harf + IDNA 'xn--' düzeltmesi -->
  <script>
  (function(){
    function __pcDecodeLabel(label){
      if (!label || label.slice(0,4)!=='xn--') return label;
      var base=36,tmin=1,tmax=26,damp=700,initial_bias=72;
      function digit(cp){return cp-48<10?cp-22:cp-65<26?cp-65:cp-97<26?cp-97:base}
      function adapt(delta,numPoints,firstTime){
        delta = firstTime ? Math.floor(delta/damp) : delta>>1;
        delta += Math.floor(delta/numPoints);
        var k=0; while (delta > (((base - tmin) * tmax) >> 1)) { delta = Math.floor(delta / (base - tmin)); k += base; }
        return k + Math.floor(((base - tmin + 1) * delta) / (delta + 38));
      }
      var n=128,i=0,bias=initial_bias; var dash=label.lastIndexOf('-'); var output=[]; var idx=4;
      if (dash>4){ for(var j=4;j<dash;j++) output.push(label.charCodeAt(j)); idx=dash+1; }
      while(idx<label.length){
        var oldi=i,w=1,k=base;
        while(true){
          if(idx>=label.length) return label;
          var d=digit(label.charCodeAt(idx++));
          i+=d*w; var t=k<=bias?1:(k>=bias+26?26:k-bias); if(d<t) break; w*=(base-t);
        }
        var outLen=output.length+1; bias=adapt(i-oldi,outLen,oldi===0); n+=Math.floor(i/outLen); i%=outLen; output.splice(i,0,n); i++;
      }
      return String.fromCharCode.apply(null, output);
    }
    window.emailNormalize = function(email){
      try{
        var s = String(email||'').trim().toLowerCase();
        var at = s.indexOf('@'); if (at<0) return s;
        var local = s.slice(0,at), domain = s.slice(at+1);
        var uni = domain.split('.').map(__pcDecodeLabel).join('.');
        try { uni = uni.normalize('NFC').replace(/i\u0307/g,'i'); } catch(e){}
        return local + '@' + uni;
      }catch(e){ return String(email||'').trim().toLowerCase(); }
    };
  })();
  </script>
</head>
<body>

  <!-- ÜST BAR -->
  <header class="bg-emerald-600 text-white">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl font-semibold">SEKAR FİLO LASTİK HAK TAKİP</h1>
      <div class="flex gap-2">
        <button id="btnExportExcel" class="btn-outline bg-white/0 text-white hover:bg-white/10">Excel'e Aktar</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 space-y-6">
    <!-- FORM + ÖNİZLEME -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- FORM -->
      <div class="card p-4">
        <h2 class="text-lg font-semibold mb-2">Lastik Siparişi</h2>
        <form id="orderForm" class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-gray-600">Lastik Ebatı</label>
            <select id="ebat" class="input w-full mt-1">
              <option value="">Seçiniz</option>
              <!-- Popüler ebatlar -->
              <option>205/55 R16</option><option>195/65 R15</option><option>185/65 R15</option>
              <option>225/45 R17</option><option>225/40 R18</option><option>235/45 R18</option>
              <option>255/45 R19</option><option>225/55 R17</option><option>215/60 R16</option>
              <option>155/80 R13</option><option>175/70 R13</option><option>175/65 R14</option>
              <!-- İsteğe göre geniş liste eklersin -->
            </select>
          </div>

          <div>
            <label class="text-sm text-gray-600">Plaka</label>
            <input id="plaka" class="input w-full mt-1 uppercase" placeholder="34ABC123" />
          </div>

          <div>
            <label class="text-sm text-gray-600">Araç KM</label>
            <input id="aracKm" type="number" class="input w-full mt-1" placeholder="120000" />
          </div>

          <div>
            <label class="text-sm text-gray-600">Lastik Firması</label>
            <input id="firma" class="input w-full mt-1" placeholder="Örn: NG FİLO LASTİK" />
          </div>

          <div>
            <label class="text-sm text-gray-600">Tür</label>
            <select id="tur" class="input w-full mt-1">
              <option>Yaz</option>
              <option>Kış</option>
            </select>
          </div>

          <div>
            <label class="text-sm text-gray-600">İsim Soyisim</label>
            <input id="adSoyad" class="input w-full mt-1" placeholder="Örn: Ali Veli" />
          </div>

          <div>
            <label class="text-sm text-gray-600">İl</label>
            <select id="il" class="input w-full mt-1">
              <option value="">İl (Seçin)</option>
            </select>
          </div>

          <div>
            <label class="text-sm text-gray-600">İlçe</label>
            <input id="ilce" class="input w-full mt-1" placeholder="İlçe" />
          </div>

          <div>
            <label class="text-sm text-gray-600">İrtibat No</label>
            <input id="irtibat" class="input w-full mt-1" placeholder="5xx xxx xx xx" />
          </div>

          <div>
            <label class="text-sm text-gray-600">E-posta</label>
            <input id="email" type="email" class="input w-full mt-1" placeholder="ornek@mail.com" />
          </div>

          <div class="md:col-span-2">
            <button class="btn w-full" type="submit">Sipariş Ekle</button>
          </div>
        </form>
      </div>

      <!-- ÖNİZLEME -->
      <div class="card p-4">
        <h2 class="text-lg font-semibold mb-2">Canlı Önizleme</h2>
        <div class="space-y-2 text-sm">
          <div class="flex items-center gap-2">
            <span class="text-gray-500 w-32">Plaka</span>
            <span id="pvPlaka" class="font-semibold">—</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-gray-500 w-32">Ebat</span>
            <span id="pvEbat">—</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-gray-500 w-32">Firma</span>
            <span id="pvFirma">—</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-gray-500 w-32">Tür</span>
            <span id="pvTur">—</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-gray-500 w-32">İsim Soyisim</span>
            <span id="pvAdSoyad">—</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-gray-500 w-32">İl/İlçe</span>
            <span id="pvIl">—</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-gray-500 w-32">E-posta</span>
            <span id="pvEmail">—</span>
          </div>
        </div>
      </div>
    </section>

    <!-- FİLTRE + TABLO -->
    <section class="card p-4">
      <div class="flex flex-wrap items-end gap-3 mb-3">
        <div>
          <label class="text-xs text-gray-500">Başlangıç</label>
          <input id="fBas" class="input" placeholder="01.01.25" />
        </div>
        <div>
          <label class="text-xs text-gray-500">Bitiş</label>
          <input id="fBit" class="input" placeholder="31.12.25" />
        </div>
        <div>
          <label class="text-xs text-gray-500">Plaka</label>
          <input id="fPlaka" class="input uppercase" placeholder="34ABC123" />
        </div>
        <div>
          <label class="text-xs text-gray-500">Firma</label>
          <input id="fFirma" class="input" placeholder="Firma ara…" />
        </div>
        <div>
          <label class="text-xs text-gray-500">Tür</label>
          <select id="fTur" class="input">
            <option value="">Hepsi</option>
            <option>Yaz</option>
            <option>Kış</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-gray-500">Ebat</label>
          <input id="fEbat" class="input" placeholder="205/55 R16" />
        </div>
        <button id="btnFilterClear" class="btn-outline">Filtreyi Temizle</button>
      </div>

      <div class="overflow-auto border rounded-xl">
        <table class="min-w-full text-sm">
          <thead>
            <tr>
              <th class="py-2 px-3 text-left">Tarih</th>
              <th class="py-2 px-3 text-left">Plaka</th>
              <th class="py-2 px-3 text-left">Ebat</th>
              <th class="py-2 px-3 text-left">Araç KM</th>
              <th class="py-2 px-3 text-left">Firma</th>
              <th class="py-2 px-3 text-left">Tür</th>
              <th class="py-2 px-3 text-left">İsim Soyisim</th>
              <th class="py-2 px-3 text-left">İl</th>
              <th class="py-2 px-3 text-left">İlçe</th>
              <th class="py-2 px-3 text-left">İrtibat</th>
              <th class="py-2 px-3 text-left">E-posta</th>
              <th class="py-2 px-3 text-left">İşlem</th>
            </tr>
          </thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Firebase (module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, orderBy, query,
      serverTimestamp, deleteDoc, doc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // === FIREBASE CONFIG (sizin verdiğiniz) ===
    const firebaseConfig = {
      apiKey: "AIzaSyB-xEmeTVN8oiB4FZzV4UpJpAHkyDHYF4U",
      authDomain: "sekar-filo.firebaseapp.com",
      projectId: "sekar-filo",
      storageBucket: "sekar-filo.appspot.com",
      messagingSenderId: "61274893830",
      appId: "1:61274893830:web:c9dfdf8baf0500178f9d87"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ====== Yardımcılar ======
    const FMT = /^(\d{2})\.(\d{2})\.(\d{2})$/;
    const pad2 = n => String(n).padStart(2,"0");
    const today = () => {
      const d = new Date();
      return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${String(d.getFullYear()).slice(-2)}`
    };
    const toDate = s => {
      const m = FMT.exec(String(s||"")); if(!m) return null;
      const d = new Date(`${2000+ +m[3]}-${m[2]}-${m[1]}T00:00:00`); return isNaN(d)?null:d;
    };

    // ====== İLLER ======
    const TR_ILLER=["Adana","Adıyaman","Afyonkarahisar","Ağrı","Aksaray","Amasya","Ankara","Antalya","Ardahan","Artvin","Aydın","Balıkesir","Bartın","Batman","Bayburt","Bilecik","Bingöl","Bitlis","Bolu","Burdur","Bursa","Çanakkale","Çankırı","Çorum","Denizli","Diyarbakır","Düzce","Edirne","Elazığ","Erzincan","Erzurum","Eskişehir","Gaziantep","Giresun","Gümüşhane","Hakkari","Hatay","Iğdır","Isparta","İstanbul","İzmir","Kahramanmaraş","Karabük","Karaman","Kars","Kastamonu","Kayseri","Kırıkkale","Kırklareli","Kırşehir","Kilis","Kocaeli","Konya","Kütahya","Malatya","Manisa","Mardin","Mersin","Muğla","Muş","Nevşehir","Niğde","Ordu","Osmaniye","Rize","Sakarya","Samsun","Siirt","Sinop","Sivas","Şanlıurfa","Şırnak","Tekirdağ","Tokat","Trabzon","Tunceli","Uşak","Van","Yalova","Yozgat","Zonguldak"];
    const ilSel = document.getElementById("il");
    TR_ILLER.forEach(il=>{ const o=document.createElement("option"); o.value=o.textContent=il; ilSel.appendChild(o); });

    // ====== Form ve Önizleme ======
    const frm = document.getElementById("orderForm");
    const ebat = document.getElementById("ebat");
    const plaka = document.getElementById("plaka");
    const aracKm = document.getElementById("aracKm");
    const firma = document.getElementById("firma");
    const tur   = document.getElementById("tur");
    const adSoyad = document.getElementById("adSoyad");
    const il    = document.getElementById("il");
    const ilce  = document.getElementById("ilce");
    const irtibat = document.getElementById("irtibat");
    const email = document.getElementById("email");

    const pvPlaka = document.getElementById("pvPlaka");
    const pvEbat  = document.getElementById("pvEbat");
    const pvFirma = document.getElementById("pvFirma");
    const pvTur   = document.getElementById("pvTur");
    const pvAdSoyad = document.getElementById("pvAdSoyad");
    const pvIl    = document.getElementById("pvIl");
    const pvEmail = document.getElementById("pvEmail");

    function syncPreview(){
      pvPlaka.textContent = (plaka.value||"—").toUpperCase();
      pvEbat.textContent  = ebat.value||"—";
      pvFirma.textContent = (firma.value||"—").toUpperCase();
      pvTur.textContent   = tur.value||"—";
      pvAdSoyad.textContent = (adSoyad.value||"—").toUpperCase();
      pvIl.textContent    = (il.value?`${il.value}`:"—") + (ilce.value?` / ${ilce.value}`:"");
      pvEmail.textContent = email.value?window.emailNormalize(email.value):"—";
    }
    [ebat,plaka,aracKm,firma,tur,adSoyad,il,ilce,irtibat,email].forEach(el=>el.addEventListener("input",syncPreview));
    syncPreview();

    // ====== Kayıt ekle ======
    frm.addEventListener("submit", async (ev)=>{
      ev.preventDefault();
      if(!ebat.value) return alert("Ebat seçiniz");
      if(!plaka.value) return alert("Plaka giriniz");
      if(!firma.value) return alert("Firma giriniz");

      const data = {
        tarih: today(),
        plaka: String(plaka.value||"").toUpperCase(),
        ebat:  String(ebat.value||""),
        arac_km: Number(aracKm.value||0),
        firma: String(firma.value||"").toUpperCase(),
        tur: String(tur.value||"").toUpperCase(),
        ad_soyad: String(adSoyad.value||"").toUpperCase(),
        il: String(il.value||"").toUpperCase(),
        ilce: String(ilce.value||"").toUpperCase(),
        irtibat_no: String(irtibat.value||""),
        email: window.emailNormalize(email.value||""),
        createdAt: serverTimestamp()
      };

      try{
        await addDoc(collection(db, "siparisler"), data);
        frm.reset(); syncPreview();
      }catch(e){ console.error(e); alert("Kayıt eklenemedi: "+e.message); }
    });

    // ====== Liste (Realtime) ======
    const tb = document.getElementById("tblBody");
    let allRows = [];

    const q = query(collection(db,"siparisler"), orderBy("createdAt","desc"));
    onSnapshot(q, (snap)=>{
      allRows = [];
      snap.forEach(d=>{
        const r = d.data(); r.id = d.id;
        allRows.push(r);
      });
      render();
    });

    // ====== Filtreler ======
    const fBas=document.getElementById("fBas");
    const fBit=document.getElementById("fBit");
    const fPlaka=document.getElementById("fPlaka");
    const fFirma=document.getElementById("fFirma");
    const fTur=document.getElementById("fTur");
    const fEbat=document.getElementById("fEbat");
    [fBas,fBit,fPlaka,fFirma,fTur,fEbat].forEach(el=>el.addEventListener("input",render));
    document.getElementById("btnFilterClear").onclick=()=>{
      [fBas,fBit,fPlaka,fFirma,fTur,fEbat].forEach(el=>el.value=""); render();
    };

    function render(){
      const s=toDate(fBas.value), e=toDate(fBit.value);
      const N=x=>String(x||"").toUpperCase();
      const Fpl=N(fPlaka.value), Ffi=N(fFirma.value), Feb=N(fEbat.value), Ft=N(fTur.value);

      const rows = allRows.filter(x=>{
        const d=toDate(x.tarih); if(!d) return false;
        if(s && d<s) return false; if(e && d>e) return false;
        if(Fpl && !N(x.plaka).includes(Fpl)) return false;
        if(Ffi && !N(x.firma).includes(Ffi)) return false;
        if(Ft  && N(x.tur)!==Ft) return false;
        if(Feb && !N(x.ebat).includes(Feb)) return false;
        return true;
      });

      tb.innerHTML="";
      rows.forEach(r=>{
        const tr=document.createElement("tr");
        tr.className="border-b last:border-0";
        tr.innerHTML=`
          <td class="px-3 py-2 whitespace-nowrap">${r.tarih||""}</td>
          <td class="px-3 py-2 whitespace-nowrap">${r.plaka||""}</td>
          <td class="px-3 py-2 whitespace-nowrap">${r.ebat||""}</td>
          <td class="px-3 py-2 whitespace-nowrap">${Number(r.arac_km||0).toLocaleString("tr-TR")}</td>
          <td class="px-3 py-2 whitespace-nowrap">${r.firma||""}</td>
          <td class="px-3 py-2 whitespace-nowrap">${r.tur||""}</td>
          <td class="px-3 py-2 whitespace-nowrap">${r.ad_soyad||""}</td>
          <td class="px-3 py-2 whitespace-nowrap">${r.il||""}</td>
          <td class="px-3 py-2 whitespace-nowrap">${r.ilce||""}</td>
          <td class="px-3 py-2 whitespace-nowrap">${r.irtibat_no||""}</td>
          <td class="px-3 py-2 whitespace-nowrap">${window.emailNormalize(r.email||"")}</td>
          <td class="px-3 py-2">
            <button class="btn-outline" data-id="${r.id}">Sil</button>
          </td>`;
        tb.appendChild(tr);
      });

      // Silme
      tb.querySelectorAll("button[data-id]").forEach(btn=>{
        btn.onclick=async()=>{
          if(!confirm("Kaydı silmek istiyor musunuz?")) return;
          try{
            await deleteDoc(doc(db,"siparisler",btn.dataset.id));
          }catch(e){ alert("Silinemedi: "+e.message); }
        };
      });
    }

    // ====== Excel'e Aktar ======
    document.getElementById("btnExportExcel").onclick=()=>{
      // tabloda görünen (filtreli) satırları topla
      const rows = [...tb.querySelectorAll("tr")].map(tr=>{
        const tds=[...tr.children].map(td=>td.textContent);
        return {
          "Tarih": tds[0], "Plaka": tds[1], "Ebat": tds[2], "Araç KM": tds[3],
          "Firma": tds[4], "Tür": tds[5], "İsim Soyisim": tds[6], "İl": tds[7],
          "İlçe": tds[8], "İrtibat": tds[9], "E-posta": tds[10]
        };
      });
      if(!rows.length) return alert("Aktarılacak satır yok.");
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Siparişler");
      XLSX.writeFile(wb, "lastik_siparisleri.xlsx");
    };
  </script>
</body>
</html>
